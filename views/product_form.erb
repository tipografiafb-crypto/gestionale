<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <h1><%= @product ? '‚úé Modifica Prodotto' : '‚ûï Nuovo Prodotto' %></h1>
    </div>
    <div class="col-md-4 text-end">
      <a href="/products" class="btn btn-secondary">‚Üê Indietro</a>
    </div>
  </div>

  <% if @error %>
    <div class="alert alert-danger mt-3">
      <strong>‚ö† Errore:</strong> <%= @error %>
    </div>
  <% end %>

  <form method="POST" action="<%= @product ? "/products/#{@product.id}?_method=PUT" : '/products' %>" class="mt-4">
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="sku" class="form-label">SKU Prodotto <span class="text-danger">*</span></label>
              <input type="text" id="sku" name="sku" class="form-control text-uppercase" 
                     value="<%= @product&.sku %>" placeholder="es. POSTER-A4" required>
              <small class="text-muted">Codice SKU (sar√† convertito in maiuscole)</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="name" class="form-label">Nome Prodotto <span class="text-danger">*</span></label>
              <input type="text" id="name" name="name" class="form-control" 
                     value="<%= @product&.name %>" placeholder="es. Poster A4 Lucido" required>
              <small class="text-muted">Nome descrittivo del prodotto</small>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="product_category_id" class="form-label">Categoria (Opzionale)</label>
              <select id="product_category_id" name="product_category_id" class="form-select">
                <option value="">-- Nessuna categoria --</option>
                <% @categories.each do |category| %>
                  <option value="<%= category.id %>" <%= 'selected' if @product&.product_category_id == category.id %>>
                    <%= category.name %>
                  </option>
                <% end %>
              </select>
              <small class="text-muted">Organizza i prodotti per categorie</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Flussi di Stampa <span class="text-danger">*</span></label>
              <div class="card">
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                  <% if @flows.empty? %>
                    <p class="text-muted mb-0">Nessun flusso disponibile</p>
                  <% else %>
                    <% 
                      selected_flow_ids = @product&.product_print_flows&.map(&:print_flow_id) || []
                      default_flow_id = @product&.product_print_flows&.find_by(default_flow: true)&.print_flow_id
                    %>
                    <% @flows.each do |flow| %>
                      <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input flow-checkbox" 
                               id="flow_<%= flow.id %>" 
                               name="flow_ids[]" 
                               value="<%= flow.id %>"
                               <%= 'checked' if selected_flow_ids.include?(flow.id) %>>
                        <label class="form-check-label" for="flow_<%= flow.id %>">
                          <strong><%= flow.name %></strong>
                          <br><small class="text-muted"><%= flow.preprint_webhook&.name %> ‚Üí <%= flow.print_webhook&.name %></small>
                        </label>
                        <div class="form-check form-check-inline ms-3" style="display: inline-block;">
                          <input type="radio" class="form-check-input default-radio" 
                                 name="default_flow_id" 
                                 value="<%= flow.id %>"
                                 id="default_<%= flow.id %>"
                                 <%= 'checked' if default_flow_id == flow.id %>
                                 <%= 'disabled' unless selected_flow_ids.include?(flow.id) %>>
                          <label class="form-check-label" for="default_<%= flow.id %>">
                            <small>Default</small>
                          </label>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
              <small class="text-muted">Seleziona uno o pi√π flussi e indica quale usare come default</small>
            </div>
          </div>
        </div>

        <script>
          // Enable/disable default radio when checkbox is toggled
          document.querySelectorAll('.flow-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
              const flowId = this.value;
              const defaultRadio = document.getElementById('default_' + flowId);
              defaultRadio.disabled = !this.checked;
              
              // If unchecking and it was default, uncheck the radio
              if (!this.checked && defaultRadio.checked) {
                defaultRadio.checked = false;
              }
              
              // If checking and no default is selected, auto-select this as default
              const anyDefaultChecked = Array.from(document.querySelectorAll('.default-radio')).some(r => r.checked);
              if (this.checked && !anyDefaultChecked) {
                defaultRadio.checked = true;
              }
            });
          });
          
          // Ensure at least one flow is selected before submit
          document.querySelector('form').addEventListener('submit', function(e) {
            const checkedFlows = document.querySelectorAll('.flow-checkbox:checked');
            if (checkedFlows.length === 0) {
              e.preventDefault();
              alert('Seleziona almeno un flusso di stampa');
              return false;
            }
            
            const defaultChecked = document.querySelector('.default-radio:checked');
            if (!defaultChecked) {
              e.preventDefault();
              alert('Seleziona un flusso di default');
              return false;
            }
          });
        </script>

        <div class="mb-3">
          <label for="notes" class="form-label">Note (Opzionale)</label>
          <textarea id="notes" name="notes" class="form-control" rows="3" placeholder="es. Cliente personalizzato, QA speciale..."><%= @product&.notes %></textarea>
          <small class="text-muted">Note interne per il tuo team</small>
        </div>

        <div class="mb-3">
          <div class="form-check">
            <input type="checkbox" id="active" name="active" class="form-check-input" value="true"
                   <%= 'checked' if !@product || @product.active %>>
            <label class="form-check-label" for="active">
              Prodotto attivo
            </label>
          </div>
          <small class="text-muted">Deseleziona per disabilitare temporaneamente questo routing</small>
        </div>
      </div>

      <div class="card-footer bg-light">
        <button type="submit" class="btn btn-primary">
          <%= @product ? 'üíæ Salva Modifiche' : '‚ûï Crea Prodotto' %>
        </button>
        <a href="/products" class="btn btn-outline-secondary">Annulla</a>
      </div>
    </div>
  </form>
</div>
