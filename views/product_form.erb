<div class="max-w-4xl mx-auto">
  <div class="flex justify-between items-start mb-6">
    <h1 class="text-3xl font-bold"><%= @product ? '‚úé Modifica Prodotto' : '‚ûï Nuovo Prodotto' %></h1>
    <a href="/products" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold transition inline-block">‚Üê Indietro</a>
  </div>

  <% if @error %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 mb-4">
      <strong>‚ö† Errore:</strong> <%= @error %>
    </div>
  <% end %>

  <form method="POST" action="<%= @product ? "/products/#{@product.id}" : '/products' %>" class="bg-white rounded-lg border border-gray-200 shadow-sm p-6 space-y-4">
    <% if @product %>
      <input type="hidden" name="_method" value="PUT">
    <% end %>
    <input type="hidden" name="authenticity_token" value="<%= session[:csrf] %>">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="sku" class="block text-sm font-semibold text-gray-700 mb-2">SKU Prodotto *</label>
        <input type="text" id="sku" name="sku" class="w-full border border-gray-300 rounded px-3 py-2 text-sm uppercase" 
               value="<%= @product&.sku %>" placeholder="es. POSTER-A4" required>
        <small class="text-gray-600">Codice SKU (sar√† convertito in maiuscole)</small>
      </div>
      <div>
        <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Nome Prodotto *</label>
        <input type="text" id="name" name="name" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" 
               value="<%= @product&.name %>" placeholder="es. Poster A4 Lucido" required>
        <small class="text-gray-600">Nome descrittivo del prodotto</small>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="product_category_id" class="block text-sm font-semibold text-gray-700 mb-2">Categoria (Opzionale)</label>
        <select id="product_category_id" name="product_category_id" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
          <option value="">-- Nessuna categoria --</option>
          <% @categories.each do |category| %>
            <option value="<%= category.id %>" <%= 'selected' if @product&.product_category_id == category.id %>>
              <%= category.name %>
            </option>
          <% end %>
        </select>
        <small class="text-gray-600">Organizza i prodotti per categorie</small>
      </div>
      <div>
        <label for="min_stock_level" class="block text-sm font-semibold text-gray-700 mb-2">Sottoscorta (Opzionale)</label>
        <input type="number" id="min_stock_level" name="min_stock_level" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" 
               value="<%= @product&.min_stock_level || 0 %>" min="0" placeholder="es. 50">
        <small class="text-gray-600">Quantit√† minima prima di avviso (0 = nessuno)</small>
      </div>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">Flussi di Stampa *</label>
      <div class="bg-gray-100 border border-gray-200 rounded p-3">
        <% if @flows.empty? %>
          <p class="text-gray-600 text-sm mb-0">Nessun flusso disponibile. <a href="/print_flows/new" class="text-blue-600 hover:text-blue-700 font-semibold">Crea un flusso</a></p>
        <% else %>
          <div class="space-y-2">
            <% @flows.each do |flow| %>
              <div class="flex items-start gap-2">
                <input type="checkbox" class="mt-1 border border-gray-300 rounded flow-checkbox" 
                       id="flow_<%= flow.id %>" name="print_flow_ids[]" value="<%= flow.id %>"
                       <%= 'checked' if @product&.print_flows&.include?(flow) %>>
                <label for="flow_<%= flow.id %>" class="text-sm">
                  <strong><%= flow.name %></strong> (Pre: <%= flow.preprint_webhook&.name %> ‚Üí Stampa: <%= flow.print_webhook&.name %>)
                </label>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <small class="text-gray-600">Seleziona uno o pi√π flussi per questo prodotto</small>
    </div>

    <div>
      <label for="default_print_flow_id" class="block text-sm font-semibold text-gray-700 mb-2">Flusso di Stampa Default *</label>
      <select id="default_print_flow_id" name="default_print_flow_id" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required>
        <option value="">-- Seleziona flusso default --</option>
        <% @flows.each do |flow| %>
          <option value="<%= flow.id %>" <%= 'selected' if @product&.default_print_flow_id == flow.id %>>
            <%= flow.name %>
          </option>
        <% end %>
      </select>
      <small class="text-gray-600">Flusso selezionato di default quando l'operatore sceglie di mandare in pre-stampa</small>
    </div>

    <div>
      <label for="notes" class="block text-sm font-semibold text-gray-700 mb-2">Note (Opzionale)</label>
      <textarea id="notes" name="notes" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" rows="3" placeholder="es. Cliente personalizzato, QA speciale..."><%= @product&.notes %></textarea>
      <small class="text-gray-600">Note interne per il tuo team</small>
    </div>

    <div class="flex gap-3 pt-4">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
        <%= @product ? 'üíæ Salva Modifiche' : '‚ûï Crea Prodotto' %>
      </button>
      <a href="/products" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold transition inline-block">Annulla</a>
    </div>
  </form>
</div>
