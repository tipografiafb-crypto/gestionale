<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>üìã Ordini</h1>
  <div class="d-flex align-items-center gap-3">
    <div class="text-muted">
      Total: <%= @orders.count %> orders
      <% if @filter_order_code.present? || @filter_store.present? || @filter_order_date.present? %>
        | <a href="/orders" class="text-reset">‚úï Azzera filtri</a>
      <% end %>
    </div>
    <a href="/orders/new" class="btn btn-primary">
      ‚ûï Aggiungi Ordine
    </a>
  </div>
</div>

<% if @orders.empty? %>
  <div class="alert alert-info">
    <h4>No orders yet</h4>
    <p>Orders will appear here when imported via the API endpoint:</p>
    <code>POST /api/orders/import</code>
  </div>
<% else %>
  <% in_progress = @orders.select { |o| %w[new sent_to_switch processing].include?(o.status) } %>
  <% completed = @orders.select { |o| %w[done error].include?(o.status) } %>
  
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="in-progress-tab" data-bs-toggle="tab" data-bs-target="#in-progress" type="button" role="tab" aria-controls="in-progress" aria-selected="true">
        ‚è≥ In Lavorazione <span class="badge bg-primary"><%= in_progress.count %></span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab" aria-controls="completed" aria-selected="false">
        ‚úÖ Completati <span class="badge bg-success"><%= completed.count %></span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button" role="tab" aria-controls="errors" aria-selected="false">
        ‚ö†Ô∏è Errori <span class="badge bg-danger"><%= @import_errors.count %></span>
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- In Progress Tab -->
    <div class="tab-pane fade show active" id="in-progress" role="tabpanel" aria-labelledby="in-progress-tab">
      <% if in_progress.empty? %>
        <div class="alert alert-info">Nessun ordine in lavorazione</div>
      <% else %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Data</th>
                <th>Negozio</th>
                <th>Codice Ordine</th>
                <th>Stato</th>
                <th>Item</th>
                <th>Asset</th>
                <th>Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr style="background-color: #f8f9fa;">
                <td>
                  <form method="get" action="/orders" class="d-inline" style="display: contents;">
                    <input type="date" class="form-control form-control-sm" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()">
                </td>
                <td>
                    <select class="form-select form-select-sm" name="store_id" onchange="this.form.submit()">
                      <option value="">Tutti</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                  </form>
              </tr>
            </thead>
            <tbody>
              <% in_progress.each do |order| %>
                <tr>
                  <td><%= order.created_at.strftime('%d-%m-%y') %></td>
                  <td><%= order.store.name %></td>
                  <td><a href="/orders/<%= order.id %>"><%= order.external_order_code %></a></td>
                  <td>
                    <span class="badge status-badge status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td><%= order.order_items.count %></td>
                  <td>
                    <%= order.assets.count %> total
                    <% if order.assets_downloaded? %>
                      <span class="badge bg-success">‚úì</span>
                    <% else %>
                      <span class="badge bg-warning text-dark">pending</span>
                    <% end %>
                  </td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <a href="/orders/<%= order.id %>" class="btn btn-sm btn-outline-secondary" style="padding: 2px 6px; font-size: 14px;" title="Visualizza">üëÅÔ∏è</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-success" style="padding: 2px 6px; font-size: 14px;" title="Duplica">üìã</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" class="d-inline" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="btn btn-sm btn-outline-danger" style="padding: 2px 6px; font-size: 14px;" title="Cancella">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Completed Tab -->
    <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
      <% if completed.empty? %>
        <div class="alert alert-info">Nessun ordine completato</div>
      <% else %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Data</th>
                <th>Negozio</th>
                <th>Codice Ordine</th>
                <th>Stato</th>
                <th>Item</th>
                <th>Asset</th>
                <th>Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr style="background-color: #f8f9fa;">
                <td>
                  <form method="get" action="/orders" class="d-inline" style="display: contents;">
                    <input type="date" class="form-control form-control-sm" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()">
                </td>
                <td>
                    <select class="form-select form-select-sm" name="store_id" onchange="this.form.submit()">
                      <option value="">Tutti</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                  </form>
              </tr>
            </thead>
            <tbody>
              <% completed.each do |order| %>
                <tr>
                  <td><%= order.created_at.strftime('%d-%m-%y') %></td>
                  <td><%= order.store.name %></td>
                  <td><a href="/orders/<%= order.id %>"><%= order.external_order_code %></a></td>
                  <td>
                    <span class="badge status-badge status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td><%= order.order_items.count %></td>
                  <td>
                    <%= order.assets.count %> total
                    <% if order.assets_downloaded? %>
                      <span class="badge bg-success">‚úì</span>
                    <% else %>
                      <span class="badge bg-warning text-dark">pending</span>
                    <% end %>
                  </td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <a href="/orders/<%= order.id %>" class="btn btn-sm btn-outline-secondary" style="padding: 2px 6px; font-size: 14px;" title="Visualizza">üëÅÔ∏è</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-success" style="padding: 2px 6px; font-size: 14px;" title="Duplica">üìã</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" class="d-inline" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="btn btn-sm btn-outline-danger" style="padding: 2px 6px; font-size: 14px;" title="Cancella">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Errors Tab -->
    <div class="tab-pane fade" id="errors" role="tabpanel" aria-labelledby="errors-tab">
      <% if @import_errors.empty? %>
        <div class="alert alert-success">‚úì Nessun errore di importazione</div>
      <% else %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Data</th>
                <th>Codice Ordine</th>
                <th>File</th>
                <th>Errore</th>
              </tr>
              <!-- Filter Row -->
              <tr style="background-color: #f8f9fa;">
                <td>
                  <form method="get" action="/orders" class="d-inline" style="display: contents;">
                    <input type="date" class="form-control form-control-sm" name="error_date" value="<%= @filter_error_date %>" onchange="this.form.submit()">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="error_order_code" placeholder="Codice ordine..." value="<%= @filter_error_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td>
                    <a href="/orders" class="btn btn-sm btn-outline-secondary" style="padding: 2px 6px; font-size: 12px;">‚úï Reset</a>
                  </form>
                </td>
              </tr>
            </thead>
            <tbody>
              <% @import_errors.each do |error| %>
                <tr>
                  <td><%= error.created_at.strftime('%d-%m-%y %H:%M') %></td>
                  <td><strong><%= error.external_order_code %></strong></td>
                  <td><code><%= error.filename %></code></td>
                  <td style="color: #dc3545;">
                    <%= error.error_message %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
