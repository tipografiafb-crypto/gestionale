<div class="mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/orders">Orders</a></li>
      <li class="breadcrumb-item"><a href="/orders/<%= @order.id %>"><%= @order.external_order_code %></a></li>
      <li class="breadcrumb-item active"><a href="/orders/<%= @order.id %>/items/<%= @item.id %>">Job <%= @item.id %></a></li>
    </ol>
  </nav>
</div>

<!-- INTESTAZIONE 2 COLONNE -->
<div class="row mb-4">
  <!-- Sinistra: Info -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <strong>Job Information</strong>
      </div>
      <div class="card-body">
        <table class="table table-sm table-borderless">
          <tr>
            <th>Order Code:</th>
            <td><strong><%= @order.external_order_code %></strong></td>
          </tr>
          <tr>
            <th>Product:</th>
            <td><strong><%= @item.product&.name || @item.sku %></strong></td>
          </tr>
          <tr>
            <th>SKU:</th>
            <td><%= @item.sku %></td>
          </tr>
          <tr>
            <th>Quantity:</th>
            <td><strong><%= @item.quantity %></strong></td>
          </tr>
          <tr>
            <th>Store:</th>
            <td><%= @order.store.code %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Destra: Product Image Preview (NOT print files) -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <strong>Product Images</strong>
      </div>
      <div class="card-body text-center">
        <% product_images = @item.assets.select { |a| a.downloaded? && a.asset_type&.start_with?('screenshot') && a.local_path_full.to_s.match?(/\.(png|jpg|jpeg|gif|webp)$/i) } %>
        <% if product_images.any? %>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <% product_images.each do |asset| %>
              <button type="button" class="btn-preview-image" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="/file/<%= asset.id %>" data-file-type="image" style="border: none; background: none; padding: 0; cursor: pointer;">
                <img src="/file/<%= asset.id %>" alt="<%= asset.asset_type %>" style="width: 100%; height: auto; cursor: pointer; border-radius: 4px;">
              </button>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">No product images available</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- BLOCCO PRINCIPALE: PRINT WORKFLOW -->
<div class="card mb-4">
  <div class="card-header">
    <strong>Print Workflow</strong>
  </div>
  <div class="card-body">
    <!-- Timeline Status -->
    <div class="mb-4" style="display: flex; gap: 40px; align-items: center; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 18px;">üñ®Ô∏è</span>
        <div>
          <% if @item.preprint_completed_at %>
            <span class="badge bg-success"><i class="fas fa-check"></i></span>
            <small class="text-muted"><%= @item.preprint_completed_at.strftime('%d-%m-%y %H:%M') %></small>
          <% elsif @item.preprint_status == 'failed' %>
            <span class="badge bg-danger">‚úó</span>
          <% else %>
            <span class="badge bg-warning text-dark"><%= @item.preprint_status&.upcase %></span>
          <% end %>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 18px;"><i class="fas fa-check-circle"></i></span>
        <div>
          <% if @item.print_completed_at %>
            <span class="badge bg-success"><i class="fas fa-check"></i></span>
            <small class="text-muted"><%= @item.print_completed_at.strftime('%d-%m-%y %H:%M') %></small>
          <% elsif @item.print_status == 'failed' %>
            <span class="badge bg-danger">‚úó</span>
          <% else %>
            <span class="badge bg-warning text-dark"><%= @item.print_status&.upcase %></span>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Print Files ONLY & Action Buttons -->
    <div class="row">
      <div class="col-md-12">
        <h6>Print Files & Actions:</h6>
        
        <% print_files = @item.assets.select { |a| a.asset_type&.start_with?('print_file') } %>
        <% if print_files.any? %>
          <div class="row mb-3">
            <% print_files.each do |asset| %>
              <div class="col-md-3 mb-3">
                <div class="card">
                  <div class="card-body text-center">
                    <% if asset.downloaded? && asset.local_path_full.to_s.match?(/\.(png|jpg|jpeg|gif|webp)$/i) %>
                      <button type="button" class="btn-preview-image" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="/file/<%= asset.id %>" data-file-type="image" style="border: none; background: none; padding: 0; cursor: pointer;">
                        <img src="/file/<%= asset.id %>" alt="<%= asset.asset_type %>" style="width: 50%; height: auto; cursor: pointer; border-radius: 4px; margin-bottom: 8px;">
                      </button>
                    <% else %>
                      <div style="background-color: #f0f0f0; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 4px; margin-bottom: 8px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="/file/<%= asset.id %>" data-file-type="pdf">
                        <i class="fas fa-file-pdf" style="font-size: 32px; color: #dc3545;"></i>
                      </div>
                    <% end %>
                    <small class="d-block"><strong>Print File</strong></small>
                    <div class="btn-group btn-group-sm mt-2" role="group">
                      <% if asset.downloaded? %>
                        <a href="/assets/<%= asset.id %>/download" class="btn btn-sm btn-outline-primary" title="Download"><i class="fas fa-download"></i></a>
                        <form action="/assets/<%= asset.id %>" method="post" class="d-inline">
                          <input type="hidden" name="_method" value="DELETE">
                          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Delete this file?');"><i class="fas fa-trash"></i></button>
                        </form>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">No print files uploaded yet. Upload files to send to print workflow.</p>
        <% end %>

        <!-- Action Buttons -->
        <% available_machines = @item.print_flow&.print_machines || [] %>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
          <!-- Pre-stampa -->
          <button type="button" class="btn btn-outline-warning" 
                  title="Configure and send to preprint"
                  data-bs-toggle="modal" data-bs-target="#flowSelectModal"
                  <%= 'disabled' if @item.preprint_completed_at %>>
<i class="fas fa-print"></i> Pre-stampa
            <% if @item.preprint_status != 'pending' %>
              <span class="badge <%= @item.preprint_status == 'completed' ? 'bg-success' : 'bg-secondary' %>">
                <%= @item.preprint_status&.upcase %>
              </span>
            <% end %>
          </button>

          <!-- Stampa -->
          <button type="button" class="btn btn-outline-success" 
                  data-bs-toggle="modal" data-bs-target="#machineSelectModal"
                  <%= 'disabled' if @item.print_completed_at %>>
<i class="fas fa-check-circle"></i> Stampa
            <% if @item.print_status != 'pending' %>
              <span class="badge <%= @item.print_status == 'completed' ? 'bg-success' : 'bg-secondary' %>">
                <%= @item.print_status&.upcase %>
              </span>
            <% end %>
          </button>

          <!-- Etichetta -->
          <% if @item.print_flow&.label_webhook %>
            <button type="button" class="btn btn-outline-primary" 
                    data-bs-toggle="modal" data-bs-target="#labelMachineSelectModal">
<i class="fas fa-tag"></i> Etichetta
            </button>
          <% end %>

          <!-- Reset -->
          <form action="/orders/<%= @order.id %>/items/<%= @item.id %>/reset" method="post" class="d-inline" onsubmit="return confirm('Reset this job?');">
            <button type="submit" class="btn btn-outline-secondary" 
                    <%= 'disabled' if @item.preprint_status == 'pending' && @item.print_status == 'pending' %>>
<i class="fas fa-redo"></i> Reset
            </button>
          </form>

          <!-- Print Card -->
          <a href="/orders/<%= @order.id %>/items/<%= @item.id %>/print" class="btn btn-outline-info" target="_blank">
<i class="fas fa-file-invoice"></i> Print Card
          </a>
        </div>

        <!-- Pre-stampa Result Section -->
        <div id="preprint-result-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
          <!-- Populated by polling: shows processing bar until Switch sends file, then shows result button -->
        </div>

        <!-- Stampa Result Section -->
        <div id="print-result-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
          <!-- Populated by polling: shows processing bar until Switch sends file, then shows result button -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->

<!-- Modal: Select Print Flow -->
<div class="modal fade" id="flowSelectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-print"></i> Pre-stampa - Configure</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/orders/<%= @order.id %>/items/<%= @item.id %>/send_preprint" method="post">
        <div class="modal-body">
          <% if @item.available_print_flows.count > 0 %>
            <div class="mb-3">
              <label class="form-label"><strong>Print Flow</strong></label>
              <% @item.available_print_flows.each do |flow| %>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="print_flow_id" 
                         value="<%= flow.id %>" id="flow_<%= flow.id %>"
                         data-flow-id="<%= flow.id %>"
                         onchange="updateAzionPhotoshopOptions(this)"
                         <%= 'checked' if flow.id == @item.product&.default_print_flow_id %>>
                  <label class="form-check-label" for="flow_<%= flow.id %>">
                    <strong><%= flow.name %></strong>
                    <% if flow.id == @item.product&.default_print_flow_id %>
                      <span class="badge bg-info">Default</span>
                    <% end %>
                  </label>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning">No print flows available</div>
          <% end %>
          
          <div id="azione-photoshop-container" class="mb-3" style="display: none;">
            <label for="azione_photoshop" class="form-label"><strong><i class="fas fa-palette"></i> Azione Photoshop</strong></label>
            <select class="form-select" id="azione_photoshop" name="azione_photoshop">
              <option value="">-- Seleziona azione --</option>
            </select>
            <small class="text-muted">Valore da inviare a Switch</small>
          </div>

          <div class="mb-3">
            <label for="percentuale" class="form-label"><strong>Percentage (%)</strong></label>
            <input type="number" class="form-control" id="percentuale" 
                   name="percentuale" value="0" step="1" min="-999" max="999"
                   placeholder="Enter percentage (e.g. +10, -5)">
            <small class="text-muted">Positive or negative value to send to Switch</small>
          </div>

          <script>
            function updateAzionPhotoshopOptions(radioElement) {
              const flowId = radioElement.value;
              const container = document.getElementById('azione-photoshop-container');
              const select = document.getElementById('azione_photoshop');
              
              if (!flowId) {
                container.style.display = 'none';
                return;
              }
              
              // Fetch azione photoshop options for this flow
              fetch(`/api/print_flows/${flowId}/azione_photoshop_options`)
                .then(response => response.json())
                .then(data => {
                  select.innerHTML = '<option value="">-- Seleziona azione --</option>';
                  
                  if (data.enabled && data.options.length > 0) {
                    data.options.forEach(option => {
                      const opt = document.createElement('option');
                      opt.value = option;
                      opt.textContent = option;
                      if (option === data.default) {
                        opt.selected = true;
                      }
                      select.appendChild(opt);
                    });
                    container.style.display = 'block';
                  } else {
                    container.style.display = 'none';
                  }
                })
                .catch(error => {
                  console.error('Error loading azione photoshop options:', error);
                  container.style.display = 'none';
                });
            }
            
            // Initialize on page load
            const checkedFlow = document.querySelector('input[name="print_flow_id"]:checked');
            if (checkedFlow) {
              updateAzionPhotoshopOptions(checkedFlow);
            }
          </script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">üñ®Ô∏è Send to Pre-stampa</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Select Machine -->
<div class="modal fade" id="machineSelectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Print Machine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/orders/<%= @order.id %>/items/<%= @item.id %>/send_print" method="post">
        <div class="modal-body">
          <p class="text-muted mb-3">Select machine for this job:</p>
          <% available_machines.each do |machine| %>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="print_machine_id" 
                     value="<%= machine.id %>" id="machine_<%= machine.id %>"
                     <%= 'checked' if available_machines.first.id == machine.id %>>
              <label class="form-check-label" for="machine_<%= machine.id %>">
                <strong><%= machine.name %></strong>
                <% if machine.description %>
                  <br><small class="text-muted"><%= machine.description %></small>
                <% end %>
              </label>
            </div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i> Send to Print</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Select Machine for Label -->
<div class="modal fade" id="labelMachineSelectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Printer for Label</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/orders/<%= @order.id %>/items/<%= @item.id %>/send_label" method="post">
        <div class="modal-body">
          <p class="text-muted mb-3">Select printer for this label:</p>
          <% available_machines.each do |machine| %>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="print_machine_id" 
                     value="<%= machine.id %>" id="label_machine_<%= machine.id %>"
                     <%= 'checked' if available_machines.first.id == machine.id %>>
              <label class="form-check-label" for="label_machine_<%= machine.id %>">
                <strong><%= machine.name %></strong>
                <% if machine.description %>
                  <br><small class="text-muted"><%= machine.description %></small>
                <% end %>
              </label>
            </div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">üè∑Ô∏è Send Label</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Preview Modal (same as before) -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">File Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
        <div id="imageContainer" style="display: none; text-align: center;">
          <img id="previewImage" class="img-fluid" alt="Preview">
        </div>
        
        <div id="pdfContainer" style="display: none;">
          <div id="pdf-viewer" style="margin-bottom: 20px;"></div>
          <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="prevPage" style="display: none;">‚Üê Previous</button>
            <span id="pageInfo" style="align-self: center;"></span>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="nextPage" style="display: none;">Next ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let currentPdf = null;
  let currentPageNum = 1;
  let currentTotalPages = 0;

  const previewModal = document.getElementById('previewModal');
  const imageContainer = document.getElementById('imageContainer');
  const pdfContainer = document.getElementById('pdfContainer');
  const previewImage = document.getElementById('previewImage');
  const pdfViewer = document.getElementById('pdf-viewer');
  const pageInfo = document.getElementById('pageInfo');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');

  previewModal.addEventListener('show.bs.modal', async function(e) {
    const button = e.relatedTarget;
    const fileUrl = button.getAttribute('data-file-url');
    const fileType = button.getAttribute('data-file-type');

    imageContainer.style.display = 'none';
    pdfContainer.style.display = 'none';
    pdfViewer.innerHTML = '';

    if (fileType === 'image') {
      previewImage.src = fileUrl;
      imageContainer.style.display = 'block';
    } else if (fileType === 'pdf') {
      try {
        const pdf = await pdfjsLib.getDocument(fileUrl).promise;
        currentPdf = pdf;
        currentPageNum = 1;
        currentTotalPages = pdf.numPages;
        pdfContainer.style.display = 'block';
        
        prevPageBtn.style.display = currentTotalPages > 1 ? 'block' : 'none';
        nextPageBtn.style.display = currentTotalPages > 1 ? 'block' : 'none';
        
        renderPage(1);
      } catch (error) {
        pdfContainer.style.display = 'block';
        pdfViewer.innerHTML = '<p class="text-danger">Error loading PDF</p>';
      }
    }
  });

  async function renderPage(pageNum) {
    if (!currentPdf) return;
    
    try {
      const page = await currentPdf.getPage(pageNum);
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const viewport = page.getViewport({ scale: 2 });
      
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      
      await page.render({ canvasContext: context, viewport }).promise;
      
      pdfViewer.innerHTML = '';
      pdfViewer.appendChild(canvas);
      
      pageInfo.textContent = 'Page ' + pageNum + ' of ' + currentTotalPages;
      currentPageNum = pageNum;
      
      prevPageBtn.disabled = pageNum === 1;
      nextPageBtn.disabled = pageNum === currentTotalPages;
    } catch (error) {
      pdfViewer.innerHTML = '<p class="text-danger">Error rendering page</p>';
    }
  }

  prevPageBtn.addEventListener('click', function() {
    if (currentPageNum > 1) {
      renderPage(currentPageNum - 1);
    }
  });

  nextPageBtn.addEventListener('click', function() {
    if (currentPageNum < currentTotalPages) {
      renderPage(currentPageNum + 1);
    }
  });
</script>

<!-- Animation for processing bar -->
<style>
  @keyframes progress {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(400%);
    }
  }
</style>

<!-- Auto-refresh preprint result section -->
<script>
  let pollingInterval = null;
  let lastKnownStatus = '<%= @item.preprint_status %>';
  
  function pollPreprintResult() {
    const orderId = '<%= @order.id %>';
    const itemId = '<%= @item.id %>';
    const preprintResultSection = document.getElementById('preprint-result-section');
    
    if (!preprintResultSection) return; // Section doesn't exist
    
    // Fetch the updated section and get the current status from the server
    fetch(`/orders/${orderId}/items/${itemId}/preprint_result_section`)
      .then(response => response.text())
      .then(html => {
        preprintResultSection.innerHTML = html;
        
        // Check if we got content (means preprint is processing or completed)
        if (html.trim() !== '') {
          console.log('[POLLING] Result section updated');
        }
      })
      .catch(error => {
        console.error('[POLLING] Error fetching preprint result:', error);
      });
  }
  
  function checkStatusAndContinuePolling() {
    const orderId = '<%= @order.id %>';
    const itemId = '<%= @item.id %>';
    
    // Fetch the item detail to check current status
    fetch(`/orders/${orderId}/items/${itemId}`)
      .then(response => response.text())
      .then(html => {
        // Extract status from the response (simple approach: check if preprint_status appears in certain state)
        // If content contains "Elaborando" or "Result" button, keep polling
        // If content shows only pending state, stop polling
        
        // Continue polling as long as preprint is not pending (i.e., it's processing or completed)
        // Stop polling only when reset (back to pending with no file)
        const hasProcessingOrResult = html.includes('Elaborando') || html.includes('Switch result');
        
        if (hasProcessingOrResult) {
          // Continue polling
          return true;
        } else {
          // Stop polling (back to pending)
          return false;
        }
      })
      .catch(error => {
        console.error('[POLLING] Error checking status:', error);
        // Continue polling on error
        return true;
      })
      .then(shouldContinue => {
        if (!shouldContinue && pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
          console.log('[POLLING] Stopped - item reset to pending');
        }
      });
  }
  
  // Start polling on page load
  document.addEventListener('DOMContentLoaded', function() {
    pollPreprintResult(); // Initial call
    
    const initialStatus = '<%= @item.preprint_status %>';
    if (initialStatus !== 'pending') {
      // Start continuous polling that will automatically stop when reset
      pollingInterval = setInterval(function() {
        pollPreprintResult();
        checkStatusAndContinuePolling();
      }, 3000);
    }
  });

  // Poll print result section
  let printPollingInterval = null;
  
  function pollPrintResult() {
    const orderId = '<%= @order.id %>';
    const itemId = '<%= @item.id %>';
    const printResultSection = document.getElementById('print-result-section');
    
    if (!printResultSection) return;
    
    fetch(`/orders/${orderId}/items/${itemId}/print_result_section`)
      .then(response => response.text())
      .then(html => {
        printResultSection.innerHTML = html;
      })
      .catch(error => {
        console.error('[POLLING] Error fetching print result:', error);
      });
  }
  
  function checkPrintStatusAndContinuePolling() {
    const orderId = '<%= @order.id %>';
    const itemId = '<%= @item.id %>';
    
    fetch(`/orders/${orderId}/items/${itemId}`)
      .then(response => response.text())
      .then(html => {
        const hasProcessingOrResult = html.includes('Elaborando') || html.includes('print_result');
        return hasProcessingOrResult;
      })
      .catch(error => {
        console.error('[POLLING] Error checking print status:', error);
        return true;
      })
      .then(shouldContinue => {
        if (!shouldContinue && printPollingInterval) {
          clearInterval(printPollingInterval);
          printPollingInterval = null;
          console.log('[POLLING] Print polling stopped');
        }
      });
  }
  
  // Start print polling if needed
  document.addEventListener('DOMContentLoaded', function() {
    const initialPrintStatus = '<%= @item.print_status %>';
    if (initialPrintStatus !== 'pending') {
      pollPrintResult();
      printPollingInterval = setInterval(function() {
        pollPrintResult();
        checkPrintStatusAndContinuePolling();
      }, 3000);
    }
  });
</script>
