<div class="mb-4">
  <nav class="text-gray-600 text-sm">
    <ol class="flex gap-2">
      <li><a href="/orders" class="text-blue-600 hover:text-blue-700 font-semibold">Orders</a></li>
      <li>/</li>
      <li class="text-gray-800"><%= @order.external_order_code %></li>
    </ol>
  </nav>
</div>

<div class="flex justify-between items-start mb-6">
  <h1 class="text-3xl font-bold">Order: <%= @order.external_order_code %></h1>
  <form action="/orders/<%= @order.id %>" method="post" onsubmit="return confirm('Sei sicuro? Eliminerai completamente questo ordine.');">
    <input type="hidden" name="_method" value="DELETE">
    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition">
      üóë Delete
    </button>
  </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Order Information</h3>
    <div class="space-y-3">
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">ID:</span>
        <span><%= @order.id %></span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">External Code:</span>
        <span class="font-semibold"><%= @order.external_order_code %></span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">Store:</span>
        <span><%= @order.store.code %> (<%= @order.store.name %>)</span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">Status:</span>
        <span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2 py-1 rounded-full"><%= @order.status.gsub('_', ' ').upcase %></span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">Created:</span>
        <span class="text-sm"><%= @order.created_at.strftime('%Y-%m-%d %H:%M:%S') %></span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-700 font-semibold">Updated:</span>
        <span class="text-sm"><%= @order.updated_at.strftime('%Y-%m-%d %H:%M:%S') %></span>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Notes</h3>
    <% if @order.notes.present? %>
      <p class="text-gray-700 whitespace-pre-wrap"><%= simple_format(@order.notes) %></p>
    <% else %>
      <p class="text-gray-500 italic">No notes</p>
    <% end %>
  </div>
</div>

<% if @order.switch_job %>
  <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Switch Job</h3>
    <div class="space-y-3 mb-4">
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">Job ID:</span>
        <span><%= @order.switch_job.switch_job_id || 'N/A' %></span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-700 font-semibold">Status:</span>
        <span class="bg-gray-200 text-gray-700 text-xs font-semibold px-2 py-1 rounded"><%= @order.switch_job.status&.upcase %></span>
      </div>
      <% if @order.switch_job.result_preview_url %>
        <div class="flex justify-between">
          <span class="text-gray-700 font-semibold">Preview:</span>
          <a href="<%= @order.switch_job.result_preview_url %>" target="_blank" class="text-blue-600 hover:text-blue-700 font-semibold">View Preview</a>
        </div>
      <% end %>
    </div>
    <% if @order.switch_job.log.present? %>
      <h6 class="text-sm font-semibold text-gray-700 mb-2">Log:</h6>
      <div class="bg-gray-900 text-gray-100 p-3 rounded text-xs font-mono max-h-64 overflow-y-auto"><%= @order.switch_job.log %></div>
    <% end %>
  </div>
<% end %>

<% if params[:msg] %>
  <div class="bg-<%= params[:msg] == 'success' ? 'green' : 'red' %>-50 border border-<%= params[:msg] == 'success' ? 'green' : 'red' %>-200 rounded-lg p-4 text-<%= params[:msg] == 'success' ? 'green' : 'red' %>-700 mb-6">
    <%= params[:text]&.gsub('+', ' ') %>
  </div>
<% end %>

<h3 class="text-xl font-semibold text-gray-800 mb-4">Order Items (<%= @order.order_items.count %>)</h3>

<% @order.order_items.each_with_index do |item, index| %>
  <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-4 overflow-hidden">
    <!-- Header: Titolo prodotto, quantit√†, e pulsanti azione -->
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-semibold text-gray-800"><%= item.product&.name || item.sku %></h4>
          <p class="text-gray-600 text-sm">Quantit√†: <strong><%= item.quantity %></strong></p>
        </div>
      </div>

      <!-- Pulsanti azione in fila -->
      <div class="flex gap-2 flex-wrap">
        <!-- Pre-stampa -->
        <button type="button" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded text-sm font-semibold transition <%= 'opacity-50 cursor-not-allowed' unless item.can_send_to_preprint? %>" 
                <%= 'disabled' unless item.can_send_to_preprint? %>
                title="<%= item.can_send_to_preprint? ? 'Configura e invia a pre-stampa' : 'Immagini non ancora scaricate' %>"
                data-bs-toggle="modal" data-bs-target="#flowSelectModal_<%= item.id %>">
          üñ®Ô∏è Pre-stampa
          <% if item.preprint_status != 'pending' %>
            <span class="bg-<%= item.preprint_status == 'completed' ? 'green' : 'gray' %>-200 text-<%= item.preprint_status == 'completed' ? 'green' : 'gray' %>-700 text-xs font-semibold px-1 py-0.5 rounded ml-1">
              <%= item.preprint_status&.upcase %>
            </span>
          <% end %>
        </button>

        <% if item.preprint_status == 'processing' %>
          <form action="/orders/<%= @order.id %>/items/<%= item.id %>/confirm_preprint" method="post" class="inline">
            <button type="submit" class="bg-cyan-100 hover:bg-cyan-200 text-cyan-700 px-3 py-2 rounded text-sm font-semibold transition" title="Conferma manualmente il completamento della pre-stampa">
              ‚úì Conferma
            </button>
          </form>
        <% end %>
        
        <!-- Stampa -->
        <% available_machines = item.print_flow&.print_machines || [] %>
        <% if available_machines.count > 1 %>
          <button type="button" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded text-sm font-semibold transition <%= 'opacity-50 cursor-not-allowed' unless item.can_send_to_print? %>" 
                  <%= 'disabled' unless item.can_send_to_print? %>
                  title="<%= item.can_send_to_print? ? 'Scegli macchina e invia in stampa' : 'Completare prima la pre-stampa' %>"
                  data-bs-toggle="modal" data-bs-target="#machineSelectModal_<%= item.id %>">
            ‚úÖ Stampa
            <% if item.print_status != 'pending' %>
              <span class="bg-<%= item.print_status == 'completed' ? 'green' : 'gray' %>-200 text-<%= item.print_status == 'completed' ? 'green' : 'gray' %>-700 text-xs font-semibold px-1 py-0.5 rounded ml-1">
                <%= item.print_status&.upcase %>
              </span>
            <% end %>
          </button>
        <% else %>
          <form action="/orders/<%= @order.id %>/items/<%= item.id %>/send_print" method="post" class="inline">
            <% if available_machines.count == 1 %>
              <input type="hidden" name="print_machine_id" value="<%= available_machines.first.id %>">
            <% end %>
            <button type="submit" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded text-sm font-semibold transition <%= 'opacity-50 cursor-not-allowed' unless item.can_send_to_print? %>" 
                    <%= 'disabled' unless item.can_send_to_print? %>
                    title="<%= item.can_send_to_print? ? 'Invia in stampa' : 'Completare prima la pre-stampa' %>">
              ‚úÖ Stampa
              <% if item.print_status != 'pending' %>
                <span class="bg-<%= item.print_status == 'completed' ? 'green' : 'gray' %>-200 text-<%= item.print_status == 'completed' ? 'green' : 'gray' %>-700 text-xs font-semibold px-1 py-0.5 rounded ml-1">
                  <%= item.print_status&.upcase %>
                </span>
              <% end %>
            </button>
          </form>
        <% end %>

        <% if item.print_status == 'processing' %>
          <form action="/orders/<%= @order.id %>/items/<%= item.id %>/confirm_print" method="post" class="inline">
            <button type="submit" class="bg-cyan-100 hover:bg-cyan-200 text-cyan-700 px-3 py-2 rounded text-sm font-semibold transition" title="Conferma manualmente il completamento della stampa">
              ‚úì Conferma
            </button>
          </form>
        <% end %>

        <!-- Etichetta -->
        <% if item.print_flow&.label_webhook %>
          <form action="/orders/<%= @order.id %>/items/<%= item.id %>/send_label" method="post" class="inline">
            <button type="submit" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm font-semibold transition" title="Invia a etichetta">
              üè∑Ô∏è Etichetta
            </button>
          </form>
        <% end %>

        <!-- Scheda Lavoro -->
        <a href="/orders/<%= @order.id %>/items/<%= item.id %>/print" class="bg-cyan-100 hover:bg-cyan-200 text-cyan-700 px-3 py-2 rounded text-sm font-semibold transition inline-block" target="_blank" title="Stampa scheda lavoro">
          üñ®Ô∏è Scheda Lavoro
        </a>

        <!-- Reset -->
        <form action="/orders/<%= @order.id %>/items/<%= item.id %>/reset" method="post" class="inline" onsubmit="return confirm('Reimpostare questo item?');">
          <button type="submit" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded text-sm font-semibold transition <%= 'opacity-50 cursor-not-allowed' if item.preprint_status == 'pending' && item.print_status == 'pending' %>" 
                  <%= 'disabled' if item.preprint_status == 'pending' && item.print_status == 'pending' %>
                  title="Reimposta a inizio workflow">
            üîÑ Reset
          </button>
        </form>
      </div>
    </div>

    <!-- Preview File e Screenshot - Piccoli thumbnails cliccabili -->
    <div class="p-6 border-b border-gray-200">
      <h6 class="font-semibold text-gray-700 mb-3">File & Anteprime:</h6>
      <div class="flex gap-4 flex-wrap">
        <!-- Assets (Print Files/Screenshots) -->
        <% if item.assets.any? %>
          <% item.assets.each do |asset| %>
            <div class="flex flex-col items-center gap-1">
              <% if asset.downloaded? && asset.local_path_full.to_s.match?(/\.(png|jpg|jpeg|gif|webp)$/i) %>
                <button type="button" class="cursor-pointer border-none bg-none p-0" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="/file/<%= asset.id %>" data-file-type="image">
                  <img src="/file/<%= asset.id %>" alt="<%= asset.asset_type %>" class="h-20 w-20 object-cover rounded border border-gray-300 hover:border-blue-500 transition">
                </button>
              <% else %>
                <button type="button" class="cursor-pointer border-none bg-none p-0" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="<%= asset.original_url %>" data-file-type="pdf">
                  <div class="h-20 w-20 rounded border border-gray-300 hover:border-blue-500 flex items-center justify-center text-2xl bg-gray-100 hover:bg-gray-200 transition">
                    üìÑ
                  </div>
                </button>
              <% end %>
              <small class="text-xs text-gray-600 text-center"><%= asset.asset_type || 'File' %></small>
            </div>
          <% end %>
        <% end %>

        <!-- Switch Previews (Pre-stampa e Stampa) -->
        <% if item.preprint_job&.result_preview_url %>
          <div class="flex flex-col items-center gap-1">
            <button type="button" class="cursor-pointer border-none bg-none p-0" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="<%= item.preprint_job.result_preview_url %>" data-file-type="pdf">
              <img src="<%= item.preprint_job.result_preview_url %>" alt="Preprint Preview" class="h-20 w-20 object-cover rounded border border-gray-300 hover:border-blue-500 transition">
            </button>
            <small class="text-xs text-gray-600">Pre-stampa</small>
          </div>
        <% end %>

        <% if item.print_job&.result_preview_url %>
          <div class="flex flex-col items-center gap-1">
            <button type="button" class="cursor-pointer border-none bg-none p-0" data-bs-toggle="modal" data-bs-target="#previewModal" data-file-url="<%= item.print_job.result_preview_url %>" data-file-type="pdf">
              <img src="<%= item.print_job.result_preview_url %>" alt="Print Preview" class="h-20 w-20 object-cover rounded border border-gray-300 hover:border-blue-500 transition">
            </button>
            <small class="text-xs text-gray-600">Stampa</small>
          </div>
        <% end %>

        <% if item.assets.empty? && !item.preprint_job&.result_preview_url && !item.print_job&.result_preview_url %>
          <p class="text-gray-500 text-sm">Nessun file disponibile</p>
        <% end %>
      </div>
    </div>

    <!-- Switch Processed Files -->
    <div class="p-6">
      <h6 class="font-semibold text-gray-700 mb-3">üìä File Processati da Switch:</h6>
      <% if @order.switch_job %>
        <div class="bg-gray-50 rounded-lg border border-gray-200 p-3">
          <p class="text-sm text-gray-700 mb-2"><strong>Status Switch:</strong> <span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2 py-0.5 rounded"><%= @order.switch_job.status&.upcase %></span></p>
          <% if @order.switch_job.result_preview_url %>
            <a href="<%= @order.switch_job.result_preview_url %>" target="_blank" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">üì• Scarica file processato</a>
          <% end %>
          <% if @order.switch_job.log.present? %>
            <details class="mt-2">
              <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">Log Switch</summary>
              <div class="bg-gray-900 text-gray-100 p-2 rounded text-xs font-mono mt-2 max-h-32 overflow-y-auto"><%= @order.switch_job.log %></div>
            </details>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-500 text-sm">In attesa di elaborazione da Switch</p>
      <% end %>
    </div>
  </div>

  <!-- Pre-stampa Modal -->
  <div class="modal fade" id="flowSelectModal_<%= item.id %>" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content rounded-lg">
        <div class="modal-header bg-gray-100 border-b">
          <h5 class="font-semibold text-gray-800">üñ®Ô∏è Pre-stampa - Configura Invio</h5>
          <button type="button" class="text-gray-600 hover:text-gray-900" data-bs-dismiss="modal">‚úï</button>
        </div>
        <form action="/orders/<%= @order.id %>/items/<%= item.id %>/send_preprint" method="post">
          <div class="modal-body">
            <% if item.available_print_flows.count > 0 %>
              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Flusso di Stampa</label>
                <div class="space-y-2">
                  <% item.available_print_flows.each do |flow| %>
                    <div class="flex items-center gap-2">
                      <input class="border border-gray-300 rounded" type="radio" name="print_flow_id" 
                             value="<%= flow.id %>" id="flow_<%= item.id %>_<%= flow.id %>"
                             <%= 'checked' if flow.id == item.product&.default_print_flow_id %>>
                      <label for="flow_<%= item.id %>_<%= flow.id %>" class="text-sm">
                        <strong><%= flow.name %></strong>
                        <% if flow.id == item.product&.default_print_flow_id %>
                          <span class="bg-blue-100 text-blue-700 text-xs font-semibold px-1 rounded">Default</span>
                        <% end %>
                      </label>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-yellow-700 text-sm">Nessun flusso di stampa disponibile</div>
            <% end %>
            
            <div class="mb-4">
              <label for="percentuale_<%= item.id %>" class="block text-sm font-semibold text-gray-700 mb-2">Percentuale (%)</label>
              <input type="number" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" id="percentuale_<%= item.id %>" 
                     name="percentuale" value="0" step="1" min="-999" max="999"
                     placeholder="Inserisci percentuale (es: +10, -5)">
              <small class="text-gray-600">Valore positivo o negativo che verr√† inviato a Switch</small>
            </div>
          </div>
          <div class="modal-footer bg-gray-100 border-t flex gap-2 justify-end">
            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded font-semibold transition" data-bs-dismiss="modal">Annulla</button>
            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded font-semibold transition">üñ®Ô∏è Invia a Pre-stampa</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Stampa Modal (se multiple machine) -->
  <% if available_machines.count > 1 %>
    <div class="modal fade" id="machineSelectModal_<%= item.id %>" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content rounded-lg">
          <div class="modal-header bg-gray-100 border-b">
            <h5 class="font-semibold text-gray-800">Scegli Macchina da Stampa</h5>
            <button type="button" class="text-gray-600 hover:text-gray-900" data-bs-dismiss="modal">‚úï</button>
          </div>
          <form action="/orders/<%= @order.id %>/items/<%= item.id %>/send_print" method="post">
            <div class="modal-body">
              <p class="text-gray-600 text-sm mb-4">Seleziona la macchina per questo lavoro:</p>
              <div class="space-y-2">
                <% available_machines.each do |machine| %>
                  <div class="flex items-start gap-2">
                    <input class="mt-1 border border-gray-300 rounded" type="radio" name="print_machine_id" 
                           value="<%= machine.id %>" id="machine_<%= item.id %>_<%= machine.id %>"
                           <%= 'checked' if available_machines.first.id == machine.id %>>
                    <label for="machine_<%= item.id %>_<%= machine.id %>" class="text-sm">
                      <strong><%= machine.name %></strong>
                      <% if machine.description %>
                        <br><small class="text-gray-600"><%= machine.description %></small>
                      <% end %>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
            <div class="modal-footer bg-gray-100 border-t flex gap-2 justify-end">
              <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded font-semibold transition" data-bs-dismiss="modal">Annulla</button>
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold transition">‚úÖ Invia in Stampa</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-lg">
      <div class="modal-header bg-gray-100 border-b">
        <h5 class="font-semibold text-gray-800">Anteprima File</h5>
        <button type="button" class="text-gray-600 hover:text-gray-900" data-bs-dismiss="modal">‚úï</button>
      </div>
      <div class="modal-body max-h-96 overflow-y-auto">
        <div id="imageContainer" style="display: none; text-align: center;">
          <img id="previewImage" class="max-w-full rounded" alt="Preview">
        </div>
        
        <div id="pdfContainer" style="display: none;">
          <div id="pdf-viewer" class="mb-5"></div>
          <div class="flex justify-center gap-2 mt-4">
            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-3 py-1 rounded text-sm font-semibold transition" id="prevPage" style="display: none;">‚Üê Precedente</button>
            <span id="pageInfo" class="text-sm text-gray-700"></span>
            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-3 py-1 rounded text-sm font-semibold transition" id="nextPage" style="display: none;">Prossima ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let currentPdf = null;
  let currentPageNum = 1;
  let currentTotalPages = 0;

  const previewModal = document.getElementById('previewModal');
  const imageContainer = document.getElementById('imageContainer');
  const pdfContainer = document.getElementById('pdfContainer');
  const previewImage = document.getElementById('previewImage');
  const pdfViewer = document.getElementById('pdf-viewer');
  const pageInfo = document.getElementById('pageInfo');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');

  previewModal.addEventListener('show.bs.modal', async function(e) {
    const button = e.relatedTarget;
    const fileUrl = button.getAttribute('data-file-url');
    const fileType = button.getAttribute('data-file-type');

    imageContainer.style.display = 'none';
    pdfContainer.style.display = 'none';
    pdfViewer.innerHTML = '';

    if (fileType === 'image') {
      previewImage.src = fileUrl;
      imageContainer.style.display = 'block';
    } else if (fileType === 'pdf') {
      try {
        const pdf = await pdfjsLib.getDocument(fileUrl).promise;
        currentPdf = pdf;
        currentPageNum = 1;
        currentTotalPages = pdf.numPages;
        pdfContainer.style.display = 'block';
        
        prevPageBtn.style.display = currentTotalPages > 1 ? 'block' : 'none';
        nextPageBtn.style.display = currentTotalPages > 1 ? 'block' : 'none';
        
        renderPage(1);
      } catch (error) {
        pdfContainer.style.display = 'block';
        pdfViewer.innerHTML = '<p class="text-red-600">Errore nel caricamento del PDF</p>';
      }
    }
  });

  async function renderPage(pageNum) {
    if (!currentPdf) return;
    
    try {
      const page = await currentPdf.getPage(pageNum);
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const viewport = page.getViewport({ scale: 2 });
      
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      
      await page.render({ canvasContext: context, viewport }).promise;
      
      pdfViewer.innerHTML = '';
      pdfViewer.appendChild(canvas);
      
      pageInfo.textContent = 'Pagina ' + pageNum + ' di ' + currentTotalPages;
      currentPageNum = pageNum;
      
      prevPageBtn.disabled = pageNum === 1;
      nextPageBtn.disabled = pageNum === currentTotalPages;
    } catch (error) {
      pdfViewer.innerHTML = '<p class="text-red-600">Errore nel rendering della pagina</p>';
    }
  }

  prevPageBtn.addEventListener('click', () => {
    if (currentPageNum > 1) renderPage(currentPageNum - 1);
  });

  nextPageBtn.addEventListener('click', () => {
    if (currentPageNum < currentTotalPages) renderPage(currentPageNum + 1);
  });
</script>
