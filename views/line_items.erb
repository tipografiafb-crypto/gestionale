
<div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
  <form method="get" action="/line_items" style="display: flex; gap: 10px; align-items: center;">
    <select class="form-select form-select-sm" name="status_filter" onchange="this.form.submit()" style="width: auto;">
      <option value="">Tutti gli stati</option>
      <option value="nuovo" <%= 'selected' if @filter_status == 'nuovo' %>>Nuovo</option>
      <option value="pre-stampa" <%= 'selected' if @filter_status == 'pre-stampa' %>>Pre-stampa (in corso)</option>
      <option value="stampa" <%= 'selected' if @filter_status == 'stampa' %>>Attende Stampa</option>
      <option value="rippato" <%= 'selected' if @filter_status == 'rippato' %>>Rippato</option>
    </select>
    <a href="/line_items" class="btn btn-outline-secondary btn-sm"><i class="fas fa-redo"></i> Reset</a>
  </form>
  
  <div style="display: flex; gap: 10px;">
    <button type="button" class="btn btn-warning btn-sm" id="btnBulkPreprint" disabled onclick="openBulkPreprintModal()">
      <i class="fas fa-cogs"></i> Invio Massivo Prestampa (<span id="selectedCountPreprint">0</span>)
    </button>
    <button type="button" class="btn btn-success btn-sm" id="btnBulkPrint" disabled onclick="openBulkPrintModal()">
      <i class="fas fa-print"></i> Invio Massivo Stampa (<span id="selectedCount">0</span>)
    </button>
  </div>
</div>

<% if @line_items.empty? %>
  <div class="alert alert-info">
    <% if @search_term.present? %>
      Nessun article trovato con il nome "<%= @search_term %>"
    <% else %>
      Nessun article in lavorazione
    <% end %>
  </div>
<% else %>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th style="width: 40px;">
            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" title="Seleziona tutti">
          </th>
          <th>Data Ordine</th>
          <th>Codice Ordine</th>
          <th>Negozio</th>
          <th>Categoria</th>
          <th>Nome Prodotto</th>
          <th>SKU</th>
          <th>Quantit√†</th>
          <th>Stato Ordine</th>
          <th>Azioni</th>
        </tr>
        <tr style="background-color: var(--neutral-100);">
          <td></td>
          <td>
            <form method="get" action="/line_items" style="display: contents;">
              <input type="date" class="form-control form-control-sm" name="order_date" value="<%= @filter_order_date %>">
          </td>
          <td>
              <input type="text" class="form-control form-control-sm" name="order_code" placeholder="Numero..." value="<%= @filter_order_code %>">
          </td>
          <td>
              <select class="form-select form-select-sm" name="store_id" onchange="this.form.submit()">
                <option value="">Tutti negozi</option>
                <% @stores.each do |store| %>
                  <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                    <%= store.name %>
                  </option>
                <% end %>
              </select>
          </td>
          <td>
              <select class="form-select form-select-sm" name="category_id" onchange="this.form.submit()">
                <option value="">Tutte categorie</option>
                <% @product_categories.each do |cat| %>
                  <option value="<%= cat.id %>" <%= 'selected' if @filter_category_id.to_s == cat.id.to_s %>>
                    <%= cat.name %>
                  </option>
                <% end %>
              </select>
          </td>
          <td>
              <input type="text" class="form-control form-control-sm" name="product_name" placeholder="Nome..." value="<%= @filter_product_name %>">
          </td>
          <td>
              <input type="text" class="form-control form-control-sm" name="sku" placeholder="SKU..." value="<%= @filter_sku %>">
          </td>
          <td></td>
          <td></td>
          <td style="display: flex; gap: 4px; justify-content: flex-end;">
              <button type="submit" class="btn btn-primary btn-sm" style="padding: 0.375rem 0.75rem;"><i class="fas fa-filter"></i> Filtra</button>
              <a href="/line_items" class="btn btn-outline-secondary btn-sm" style="padding: 0.375rem 0.75rem;"><i class="fas fa-redo"></i> Reset</a>
            </form>
          </td>
        </tr>
      </thead>
      <tbody>
        <% @line_items.each do |li| %>
          <% can_select = li[:item].preprint_status == 'pending' || (li[:item].preprint_status == 'completed' && li[:item].print_status == 'pending') %>
          <tr>
            <td>
              <% if can_select %>
                <input type="checkbox" class="item-checkbox" 
                       data-item-id="<%= li[:item].id %>" 
                       data-order-id="<%= li[:order].id %>"
                       data-sku="<%= li[:item].sku %>"
                       data-preprint-status="<%= li[:item].preprint_status %>"
                       data-print-status="<%= li[:item].print_status %>"
                       onclick="updateSelectedCount()">
              <% end %>
            </td>
            <td><%= li[:order].created_at.strftime('%d-%m-%y') %></td>
            <td><a href="/orders/<%= li[:order].id %>"><%= li[:order].external_order_code %></a></td>
            <td><%= li[:order].store.name %></td>
            <td><span class="badge bg-light text-dark"><%= li[:category_name] %></span></td>
            <td><strong><%= li[:product_name] %></strong></td>
            <td><code><%= li[:item].sku %></code></td>
            <td><%= li[:item].quantity %></td>
            <td>
              <% workflow_status = li[:item].workflow_status %>
              <% status_color = case workflow_status
                when 'nuovo'
                  'bg-info'
                when 'pre-stampa'
                  'bg-warning text-dark'
                when 'stampa'
                  'bg-primary'
                when 'rippato'
                  'bg-purple'
                when 'completato'
                  'bg-success'
                else
                  'bg-secondary'
                end %>
              <span class="badge <%= status_color %>" style="<%= 'background-color: #6f42c1 !important;' if workflow_status == 'rippato' %>">
                <%= workflow_status.upcase %>
              </span>
            </td>
            <td>
              <div style="display: flex; gap: 4px;">
                <a href="/orders/<%= li[:order].id %>/items/<%= li[:item].id %>" class="btn btn-sm btn-outline-secondary" style="padding: 2px 6px; font-size: 14px;" title="Visualizza job"><i class="fas fa-eye"></i></a>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <div class="alert alert-info mt-4">
    <strong>Totale:</strong> <%= @line_items.count %> article da elaborare
  </div>
<% end %>

<!-- Modal Bulk Preprint -->
<div class="modal fade" id="bulkPreprintModal" tabindex="-1" aria-labelledby="bulkPreprintModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkPreprintModalLabel"><i class="fas fa-cogs"></i> Invio Massivo a Prestampa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Stai per inviare <strong id="modalItemCountPreprint">0</strong> elementi a prestampa.</p>
        
        <div class="mb-3">
          <label for="bulkPreprintFlow" class="form-label">Seleziona Flusso di Stampa</label>
          <select class="form-select" id="bulkPreprintFlow" required>
            <option value="">-- Seleziona flusso --</option>
            <% @print_flows.each do |flow| %>
              <option value="<%= flow.id %>"><%= flow.name %></option>
            <% end %>
          </select>
        </div>
        
        <div id="bulkPreprintProgress" style="display: none;">
          <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBarPreprint"></div>
          </div>
          <p class="small text-muted" id="progressTextPreprint">Elaborazione in corso...</p>
        </div>
        
        <div id="bulkPreprintResults" style="display: none;">
          <hr>
          <h6>Risultati:</h6>
          <ul id="resultsListPreprint" class="small"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button type="button" class="btn btn-warning" id="btnConfirmBulkPreprint" onclick="executeBulkPreprint()">
          <i class="fas fa-paper-plane"></i> Invia a Prestampa
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Bulk Print -->
<div class="modal fade" id="bulkPrintModal" tabindex="-1" aria-labelledby="bulkPrintModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkPrintModalLabel"><i class="fas fa-print"></i> Invio Massivo a Stampa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Stai per inviare <strong id="modalItemCount">0</strong> elementi alla stampante.</p>
        
        <div class="mb-3">
          <label for="bulkPrintMachine" class="form-label">Seleziona Macchina da Stampa</label>
          <select class="form-select" id="bulkPrintMachine" required>
            <option value="">-- Seleziona stampante --</option>
            <% @print_machines.each do |machine| %>
              <option value="<%= machine.id %>"><%= machine.display_name %></option>
            <% end %>
          </select>
        </div>
        
        <div id="bulkPrintProgress" style="display: none;">
          <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
          </div>
          <p class="small text-muted" id="progressText">Elaborazione in corso...</p>
        </div>
        
        <div id="bulkPrintResults" style="display: none;">
          <hr>
          <h6>Risultati:</h6>
          <ul id="resultsList" class="small"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCloseModal">Chiudi</button>
        <button type="button" class="btn btn-success" id="btnConfirmBulkPrint" onclick="executeBulkPrint()">
          <i class="fas fa-paper-plane"></i> Invia a Stampa
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.item-checkbox');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const checked = document.querySelectorAll('.item-checkbox:checked');
  
  // Count items by preprint status
  const preprintItems = Array.from(checked).filter(cb => cb.dataset.preprintStatus === 'pending');
  const printItems = Array.from(checked).filter(cb => cb.dataset.preprintStatus === 'completed');
  
  // Update counts
  document.getElementById('selectedCountPreprint').textContent = preprintItems.length;
  document.getElementById('selectedCount').textContent = printItems.length;
  
  // Enable/disable buttons based on selected items
  document.getElementById('btnBulkPreprint').disabled = preprintItems.length === 0;
  document.getElementById('btnBulkPrint').disabled = printItems.length === 0;
  
  const selectAll = document.getElementById('selectAll');
  const allCheckboxes = document.querySelectorAll('.item-checkbox');
  if (allCheckboxes.length > 0) {
    selectAll.checked = checked.length === allCheckboxes.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < allCheckboxes.length;
  }
}

function openBulkPrintModal() {
  const checked = document.querySelectorAll('.item-checkbox:checked');
  document.getElementById('modalItemCount').textContent = checked.length;
  document.getElementById('bulkPrintProgress').style.display = 'none';
  document.getElementById('bulkPrintResults').style.display = 'none';
  document.getElementById('btnConfirmBulkPrint').disabled = false;
  document.getElementById('btnConfirmBulkPrint').style.display = 'inline-block';
  document.getElementById('bulkPrintMachine').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('bulkPrintModal'));
  modal.show();
}

async function executeBulkPrint() {
  const printMachineId = document.getElementById('bulkPrintMachine').value;
  if (!printMachineId) {
    alert('Seleziona una macchina da stampa');
    return;
  }
  
  const checked = document.querySelectorAll('.item-checkbox:checked');
  // Filter only items with preprint_status == 'completed' (pronti per stampa)
  const items = Array.from(checked)
    .filter(cb => cb.dataset.preprintStatus === 'completed')
    .map(cb => ({
      itemId: cb.dataset.itemId,
      orderId: cb.dataset.orderId,
      sku: cb.dataset.sku
    }));
  
  if (items.length === 0) {
    alert('Seleziona solo item pronti per la stampa (con pre-stampa completata)');
    return;
  }
  
  document.getElementById('btnConfirmBulkPrint').disabled = true;
  document.getElementById('bulkPrintProgress').style.display = 'block';
  document.getElementById('bulkPrintResults').style.display = 'block';
  document.getElementById('resultsList').innerHTML = '';
  
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const resultsList = document.getElementById('resultsList');
  
  let successCount = 0;
  let errorCount = 0;
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    const percent = Math.round(((i + 1) / items.length) * 100);
    progressBar.style.width = percent + '%';
    progressText.textContent = `Elaborazione ${i + 1} di ${items.length}...`;
    
    try {
      const response = await fetch('/api/v1/bulk_print_item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          order_id: item.orderId,
          item_id: item.itemId,
          print_machine_id: printMachineId
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        successCount++;
        resultsList.innerHTML += `<li class="text-success"><i class="fas fa-check"></i> ${item.sku} - Inviato con successo</li>`;
        checked[i].closest('tr').querySelector('.badge').textContent = 'RIPPATO';
        checked[i].closest('tr').querySelector('.badge').style.backgroundColor = '#6f42c1';
        checked[i].checked = false;
        checked[i].style.display = 'none';
      } else {
        errorCount++;
        resultsList.innerHTML += `<li class="text-danger"><i class="fas fa-times"></i> ${item.sku} - ${result.error || 'Errore sconosciuto'}</li>`;
      }
    } catch (err) {
      errorCount++;
      resultsList.innerHTML += `<li class="text-danger"><i class="fas fa-times"></i> ${item.sku} - Errore di rete</li>`;
    }
    
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  progressText.textContent = `Completato: ${successCount} successi, ${errorCount} errori`;
  document.getElementById('btnConfirmBulkPrint').style.display = 'none';
  updateSelectedCount();
}

function openBulkPreprintModal() {
  const checked = document.querySelectorAll('.item-checkbox:checked');
  document.getElementById('modalItemCountPreprint').textContent = checked.length;
  document.getElementById('bulkPreprintProgress').style.display = 'none';
  document.getElementById('bulkPreprintResults').style.display = 'none';
  document.getElementById('btnConfirmBulkPreprint').disabled = false;
  document.getElementById('btnConfirmBulkPreprint').style.display = 'inline-block';
  document.getElementById('bulkPreprintFlow').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('bulkPreprintModal'));
  modal.show();
}

async function executeBulkPreprint() {
  const printFlowId = document.getElementById('bulkPreprintFlow').value;
  if (!printFlowId) {
    alert('Seleziona un flusso di stampa');
    return;
  }
  
  const checked = document.querySelectorAll('.item-checkbox:checked');
  // Filter only items with preprint_status == 'pending' (stato "nuovo")
  const items = Array.from(checked)
    .filter(cb => cb.dataset.preprintStatus === 'pending')
    .map(cb => ({
      itemId: cb.dataset.itemId,
      orderId: cb.dataset.orderId,
      sku: cb.dataset.sku
    }));
  
  if (items.length === 0) {
    alert('Seleziona solo item con stato "Nuovo"');
    return;
  }
  
  document.getElementById('btnConfirmBulkPreprint').disabled = true;
  document.getElementById('bulkPreprintProgress').style.display = 'block';
  document.getElementById('bulkPreprintResults').style.display = 'block';
  document.getElementById('resultsListPreprint').innerHTML = '';
  
  const progressBar = document.getElementById('progressBarPreprint');
  const progressText = document.getElementById('progressTextPreprint');
  const resultsList = document.getElementById('resultsListPreprint');
  
  let successCount = 0;
  let errorCount = 0;
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    const percent = Math.round(((i + 1) / items.length) * 100);
    progressBar.style.width = percent + '%';
    progressText.textContent = `Elaborazione ${i + 1} di ${items.length}...`;
    
    try {
      const response = await fetch('/api/v1/bulk_preprint_item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          order_id: item.orderId,
          item_id: item.itemId,
          print_flow_id: printFlowId
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        successCount++;
        resultsList.innerHTML += `<li class="text-success"><i class="fas fa-check"></i> ${item.sku} - Inviato con successo</li>`;
        checked[i].closest('tr').querySelector('.badge').textContent = 'PRE-STAMPA';
        checked[i].closest('tr').querySelector('.badge').style.backgroundColor = '#ffc107';
        checked[i].checked = false;
        checked[i].style.display = 'none';
      } else {
        errorCount++;
        resultsList.innerHTML += `<li class="text-danger"><i class="fas fa-times"></i> ${item.sku} - ${result.error || 'Errore sconosciuto'}</li>`;
      }
    } catch (err) {
      errorCount++;
      resultsList.innerHTML += `<li class="text-danger"><i class="fas fa-times"></i> ${item.sku} - Errore di rete</li>`;
    }
    
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  progressText.textContent = `Completato: ${successCount} successi, ${errorCount} errori`;
  document.getElementById('btnConfirmBulkPreprint').style.display = 'none';
  updateSelectedCount();
}
</script>
