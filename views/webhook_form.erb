<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <h1><%= @webhook ? '‚úé Modifica Webhook' : '‚ûï Nuovo Webhook' %></h1>
    </div>
    <div class="col-md-4 text-end">
      <a href="/webhooks" class="btn btn-secondary">‚Üê Indietro</a>
    </div>
  </div>

  <% if @error %>
    <div class="alert alert-danger mt-3">
      <strong>‚ö† Errore:</strong> <%= @error %>
    </div>
  <% end %>

  <form method="POST" action="<%= @webhook ? "/webhooks/#{@webhook.id}" : '/webhooks' %>" class="mt-4">
    <% if @webhook %>
      <input type="hidden" name="_method" value="PUT">
    <% end %>
    <div class="card">
      <div class="card-body">
        <div class="mb-3">
          <label for="name" class="form-label">Nome Webhook <span class="text-danger">*</span></label>
          <input type="text" id="name" name="name" class="form-control" 
                 value="<%= @webhook&.name %>" placeholder="es. Main Switch, Backup Switch" required>
          <small class="text-muted">Nome descrittivo per identificare questo webhook</small>
        </div>

        <div class="mb-3">
          <label for="hook_path" class="form-label">Hook Path <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><%= ENV['SWITCH_WEBHOOK_BASE_URL'] || 'http://localhost:9000' %></span>
            <input type="text" id="hook_path" name="hook_path" class="form-control" 
                   value="<%= @webhook&.hook_path %>" placeholder="/api/jobs" required>
          </div>
          <small class="text-muted">Inserisci solo il path (es. /api/jobs o /webhook/switch). L'URL base √® configurato a livello di sistema.</small>
        </div>

        <div class="mb-3">
          <label for="store_id" class="form-label">Negozio (Opzionale)</label>
          <select id="store_id" name="store_id" class="form-select">
            <option value="">-- Globale (tutti i negozi) --</option>
            <% @stores.each do |store| %>
              <option value="<%= store.id %>" <%= 'selected' if @webhook&.store_id == store.id %>>
                <%= store.name %> (<%= store.code %>)
              </option>
            <% end %>
          </select>
          <small class="text-muted">Se non specificato, questo webhook sar√† usato per tutti i negozi</small>
        </div>

        <div class="mb-3">
          <input type="hidden" name="active" value="false">
          <div class="form-check">
            <input type="checkbox" id="active" name="active" class="form-check-input" value="true"
                   <%= 'checked' if !@webhook || @webhook.active %>>
            <label class="form-check-label" for="active">
              Webhook attivo
            </label>
          </div>
          <small class="text-muted">Deseleziona per disabilitare temporaneamente questo webhook</small>
        </div>
      </div>

      <div class="card-footer bg-light">
        <button type="submit" class="btn btn-primary">
          <%= @webhook ? 'üíæ Salva Modifiche' : '‚ûï Crea Webhook' %>
        </button>
        <a href="/webhooks" class="btn btn-outline-secondary">Annulla</a>
        <% if @webhook %>
          <button type="button" class="btn btn-outline-danger float-end" onclick="deleteWebhookForm()">üóë Elimina</button>
        <% end %>
      </div>
    </div>
  </form>
</div>

<% if @webhook %>
<script>
function deleteWebhookForm() {
  if (confirm('Sei sicuro? Eliminerai questo webhook.')) {
    fetch('/webhooks/<%= @webhook.id %>', { 
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(() => window.location.href = '/webhooks?success=deleted')
    .catch(err => alert('Errore: ' + err));
  }
}
</script>
<% end %>
