<div class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold">üìã Ordini</h1>
  <div class="flex items-center gap-6">
    <div class="text-gray-600 text-sm">
      <span class="font-semibold"><%= @orders.count %></span> ordini totali
      <% if @filter_order_code.present? || @filter_store.present? || @filter_order_date.present? %>
        | <a href="/orders" class="text-blue-600 hover:text-blue-700 ml-2">‚úï Azzera filtri</a>
      <% end %>
    </div>
    <a href="/orders/new" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
      ‚ûï Aggiungi Ordine
    </a>
  </div>
</div>

<% if @orders.empty? %>
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-700">
    <h4 class="font-bold mb-2">Nessun ordine</h4>
    <p class="text-sm">Gli ordini appariranno qui quando importati via endpoint API:</p>
    <code class="bg-blue-100 px-2 py-1 rounded text-xs">POST /api/orders/import</code>
  </div>
<% else %>
  <% in_progress = @orders.select { |o| %w[new sent_to_switch processing].include?(o.status) } %>
  <% completed = @orders.select { |o| %w[done error].include?(o.status) } %>
  
  <div class="border-b border-gray-200 mb-6">
    <div class="flex gap-8" role="tablist">
      <button class="tab-btn active border-b-2 border-blue-600 pb-3 font-semibold text-gray-800 hover:text-blue-600 transition" data-tab="in-progress" role="tab">
        ‚è≥ In Lavorazione <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full ml-2"><%= in_progress.count %></span>
      </button>
      <button class="tab-btn border-b-2 border-transparent pb-3 font-semibold text-gray-600 hover:text-blue-600 transition" data-tab="completed" role="tab">
        ‚úÖ Completati <span class="bg-green-600 text-white text-xs px-2 py-0.5 rounded-full ml-2"><%= completed.count %></span>
      </button>
      <button class="tab-btn border-b-2 border-transparent pb-3 font-semibold text-gray-600 hover:text-blue-600 transition" data-tab="errors" role="tab">
        ‚ö†Ô∏è Errori <span class="bg-red-600 text-white text-xs px-2 py-0.5 rounded-full ml-2"><%= @import_errors.count %></span>
      </button>
    </div>
  </div>

  <div class="tab-content">
    <!-- In Progress Tab -->
    <div class="tab-pane active" id="in-progress" role="tabpanel">
      <% if in_progress.empty? %>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-700">Nessun ordine in lavorazione</div>
      <% else %>
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-100 border-b border-gray-200">
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Negozio</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Codice Ordine</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Stato</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Item</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Asset</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr class="bg-gray-50 border-b border-gray-200">
                <td class="px-4 py-3">
                  <form method="get" action="/orders" class="contents">
                    <input type="date" class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()">
                </td>
                <td class="px-4 py-3">
                    <select class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="store_id" onchange="this.form.submit()">
                      <option value="">Tutti</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                  </form>
              </tr>
            </thead>
            <tbody>
              <% in_progress.each do |order| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                  <td class="px-4 py-3 text-sm"><%= order.created_at.strftime('%d-%m-%y') %></td>
                  <td class="px-4 py-3 text-sm"><%= order.store.name %></td>
                  <td class="px-4 py-3 text-sm"><a href="/orders/<%= order.id %>" class="text-blue-600 hover:text-blue-700 font-semibold"><%= order.external_order_code %></a></td>
                  <td class="px-4 py-3">
                    <span class="status-badge status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm"><%= order.order_items.count %></td>
                  <td class="px-4 py-3 text-sm">
                    <%= order.assets.count %> tot
                    <% if order.assets_downloaded? %>
                      <span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-semibold">‚úì</span>
                    <% else %>
                      <span class="inline-block bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs font-semibold">pending</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex gap-2">
                      <a href="/orders/<%= order.id %>" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-sm font-semibold transition" title="Visualizza">üëÅÔ∏è</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" class="inline">
                        <button type="submit" class="bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded text-sm font-semibold transition" title="Duplica">üìã</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" class="inline" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-sm font-semibold transition" title="Cancella">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Completed Tab -->
    <div class="tab-pane hidden" id="completed" role="tabpanel">
      <% if completed.empty? %>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-700">Nessun ordine completato</div>
      <% else %>
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-100 border-b border-gray-200">
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Negozio</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Codice Ordine</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Stato</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Item</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Asset</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr class="bg-gray-50 border-b border-gray-200">
                <td class="px-4 py-3">
                  <form method="get" action="/orders" class="contents">
                    <input type="date" class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()">
                </td>
                <td class="px-4 py-3">
                    <select class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="store_id" onchange="this.form.submit()">
                      <option value="">Tutti</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                  </form>
              </tr>
            </thead>
            <tbody>
              <% completed.each do |order| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                  <td class="px-4 py-3 text-sm"><%= order.created_at.strftime('%d-%m-%y') %></td>
                  <td class="px-4 py-3 text-sm"><%= order.store.name %></td>
                  <td class="px-4 py-3 text-sm"><a href="/orders/<%= order.id %>" class="text-blue-600 hover:text-blue-700 font-semibold"><%= order.external_order_code %></a></td>
                  <td class="px-4 py-3">
                    <span class="status-badge status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm"><%= order.order_items.count %></td>
                  <td class="px-4 py-3 text-sm">
                    <%= order.assets.count %> tot
                    <% if order.assets_downloaded? %>
                      <span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-semibold">‚úì</span>
                    <% else %>
                      <span class="inline-block bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs font-semibold">pending</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex gap-2">
                      <a href="/orders/<%= order.id %>" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-sm font-semibold transition" title="Visualizza">üëÅÔ∏è</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" class="inline">
                        <button type="submit" class="bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded text-sm font-semibold transition" title="Duplica">üìã</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" class="inline" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-sm font-semibold transition" title="Cancella">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Errors Tab -->
    <div class="tab-pane hidden" id="errors" role="tabpanel">
      <% if @import_errors.empty? %>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-green-700">‚úì Nessun errore di importazione</div>
      <% else %>
        <div class="flex justify-end mb-4">
          <form action="/import_errors/clear_all" method="post" class="inline" onsubmit="return confirm('Cancellare TUTTI gli errori? Questa azione non pu√≤ essere annullata.');">
            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition">
              üóëÔ∏è Cancella tutti gli errori
            </button>
          </form>
        </div>
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-100 border-b border-gray-200">
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Codice Ordine</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">File</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Errore</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-20">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr class="bg-gray-50 border-b border-gray-200">
                <td class="px-4 py-3">
                  <form method="get" action="/orders" class="contents">
                    <input type="date" class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="error_date" value="<%= @filter_error_date %>" onchange="this.form.submit()">
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="border border-gray-300 rounded px-2 py-1 text-sm w-full" name="error_order_code" placeholder="Codice..." value="<%= @filter_error_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td></td>
                <td class="px-4 py-3">
                    <a href="/orders" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-2 py-1 rounded text-xs font-semibold transition inline-block">‚úï Reset</a>
                  </form>
                </td>
              </tr>
            </thead>
            <tbody>
              <% @import_errors.each do |error| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                  <td class="px-4 py-3 text-sm"><%= error.created_at.strftime('%d-%m-%y %H:%M') %></td>
                  <td class="px-4 py-3 text-sm font-semibold"><%= error.external_order_code %></td>
                  <td class="px-4 py-3 text-sm"><code class="bg-gray-100 px-2 py-1 rounded text-xs"><%= error.filename %></code></td>
                  <td class="px-4 py-3 text-sm text-red-700">
                    <%= error.error_message %>
                  </td>
                  <td class="px-4 py-3">
                    <form action="/import_errors/<%= error.id %>/delete" method="post" class="inline" onsubmit="return confirm('Cancellare questo errore?');">
                      <button type="submit" class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-sm font-semibold transition" title="Cancella">üóë</button>
                    </form>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<script>
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Hide all tabs
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
      // Show selected tab
      document.getElementById(btn.dataset.tab).classList.remove('hidden');
      
      // Update button styles
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('border-blue-600', 'text-gray-800');
        b.classList.add('border-transparent', 'text-gray-600');
      });
      btn.classList.remove('border-transparent', 'text-gray-600');
      btn.classList.add('border-blue-600', 'text-gray-800');
    });
  });
</script>
