<div class="container mt-5" style="max-width: 600px;">
  <h1><%= @flow&.id ? "Modifica Flusso di Stampa" : "Nuovo Flusso di Stampa" %></h1>

  <% if @error %>
    <div class="alert alert-danger"><%= @error %></div>
  <% end %>

  <form action="<%= @flow&.id ? "/print_flows/#{@flow.id}" : "/print_flows" %>" method="post">
    <% if @flow&.id %>
      <input type="hidden" name="_method" value="PUT">
    <% end %>

    <div class="mb-3">
      <label for="name" class="form-label">Nome Flusso *</label>
      <input type="text" class="form-control" id="name" name="name" value="<%= @flow&.name %>" required>
      <small class="text-muted">Es: "Pre-press â†’ Print Color", "B&W Production"</small>
    </div>

    <div class="mb-3">
      <label for="preprint_webhook_id" class="form-label">Webhook Pre-Stampa *</label>
      <select class="form-select" id="preprint_webhook_id" name="preprint_webhook_id" required>
        <option value="">-- Seleziona webhook pre-stampa --</option>
        <% @webhooks.each do |webhook| %>
          <option value="<%= webhook.id %>" <%= 'selected' if @flow&.preprint_webhook_id == webhook.id %>>
            <%= webhook.name %> (<%= webhook.hook_path %>)
          </option>
        <% end %>
      </select>
      <small class="text-muted">Webhook per la fase di preparazione e validazione dei file</small>
    </div>

    <div class="mb-3">
      <label for="print_webhook_id" class="form-label">Webhook Stampa *</label>
      <select class="form-select" id="print_webhook_id" name="print_webhook_id" required>
        <option value="">-- Seleziona webhook stampa --</option>
        <% @webhooks.each do |webhook| %>
          <option value="<%= webhook.id %>" <%= 'selected' if @flow&.print_webhook_id == webhook.id %>>
            <%= webhook.name %> (<%= webhook.hook_path %>)
          </option>
        <% end %>
      </select>
      <small class="text-muted">Webhook per l'invio dei file alle macchine di stampa</small>
    </div>

    <% if @flow&.id %>
    <div class="mb-3 p-3 bg-light border rounded">
      <label class="form-label fw-bold">ðŸ”§ Macchine da Stampa Disponibili</label>
      <p class="text-muted small mb-2">Seleziona le macchine disponibili per questo flusso</p>
      
      <% if @machines.any? %>
        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
          <% @machines.each do |machine| %>
            <label class="list-group-item">
              <input type="checkbox" name="machine_ids[]" value="<%= machine.id %>" 
                     <%= 'checked' if @flow.print_machines.include?(machine) %>>
              <strong><%= machine.name %></strong>
              <% if machine.description %>
                <br><small class="text-muted"><%= machine.description %></small>
              <% end %>
            </label>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-info small mb-0">
          Nessuna macchina configurata. <a href="/admin/print_machines">Crea una macchina</a>
        </div>
      <% end %>
    </div>
    <% end %>

    <div class="mb-3">
      <label for="label_webhook_id" class="form-label">Webhook Etichetta (opzionale)</label>
      <select class="form-select" id="label_webhook_id" name="label_webhook_id">
        <option value="">-- Nessun webhook etichetta --</option>
        <% @webhooks.each do |webhook| %>
          <option value="<%= webhook.id %>" <%= 'selected' if @flow&.label_webhook_id == webhook.id %>>
            <%= webhook.name %> (<%= webhook.hook_path %>)
          </option>
        <% end %>
      </select>
      <small class="text-muted">Webhook opzionale per l'invio delle etichette</small>
    </div>

    <div class="mb-3">
      <label for="notes" class="form-label">Note</label>
      <textarea class="form-control" id="notes" name="notes" rows="2"><%= @flow&.notes %></textarea>
    </div>

    <div class="card mb-3">
      <div class="card-header">
        <h5>ðŸŽ¨ Azione Photoshop (Opzionale)</h5>
      </div>
      <div class="card-body">
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="azione_photoshop_enabled" 
                 name="azione_photoshop_enabled" value="1"
                 <%= 'checked' if @flow&.azione_photoshop_enabled %>>
          <label class="form-check-label" for="azione_photoshop_enabled">
            <strong>Abilita Azione Photoshop</strong>
          </label>
          <small class="d-block text-muted mt-1">Attiva il selettore di azione photoshop durante la pre-stampa</small>
        </div>

        <div id="azione-photoshop-options" style="<%= 'display: none;' unless @flow&.azione_photoshop_enabled %>">
          <div class="mb-3">
            <label for="azione_photoshop_options" class="form-label"><strong>Valori disponibili</strong></label>
            <textarea class="form-control" id="azione_photoshop_options" name="azione_photoshop_options" 
                      rows="4" placeholder="Inserisci i valori uno per riga&#10;Es:&#10;plettri bianchi&#10;plettri neri&#10;plettri rossi"><%= @flow&.azione_photoshop_options %></textarea>
            <small class="text-muted">Un valore per riga. Questi valori appariranno nel dropdown durante la pre-stampa</small>
          </div>

          <div class="mb-3">
            <label for="default_azione_photoshop" class="form-label">Valore di Default</label>
            <input type="text" class="form-control" id="default_azione_photoshop" 
                   name="default_azione_photoshop" value="<%= @flow&.default_azione_photoshop %>"
                   placeholder="Valore di default (deve essere nella lista dei valori sopra)">
            <small class="text-muted">Il valore selezionato di default nel dropdown</small>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">ðŸ’¾ Salva Flusso</button>
      <a href="/print_flows" class="btn btn-secondary">Annulla</a>
    </div>

    <script>
      document.getElementById('azione_photoshop_enabled').addEventListener('change', function() {
        const optionsDiv = document.getElementById('azione-photoshop-options');
        optionsDiv.style.display = this.checked ? 'block' : 'none';
      });
    </script>
  </form>
</div>
