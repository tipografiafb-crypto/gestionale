<div class="mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/orders">Orders</a></li>
      <li class="breadcrumb-item"><a href="/aggregated_jobs">Lavori Aggregati</a></li>
      <li class="breadcrumb-item active">#<%= @aggregated_job.id %> - <%= @aggregated_job.name %></li>
    </ol>
  </nav>
</div>

<div class="row mb-4">
  <div class="col-md-8">
    <h1><i class="fas fa-layer-group"></i> <%= @aggregated_job.name %></h1>
  </div>
  <div class="col-md-4 text-end">
    <span class="badge bg-<%= @aggregated_job.status_color %> fs-5">
      <%= @aggregated_job.status_label %>
    </span>
  </div>
</div>

<% if params[:msg] %>
  <% alert_type = case params[:msg]
    when 'success'
      'success'
    else
      'danger'
    end %>
  <div class="alert alert-<%= alert_type %> alert-dismissible fade show" role="alert">
    <%= params[:text]&.gsub('+', ' ') %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% end %>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header">
        <strong><i class="fas fa-list"></i> Line Items Aggregati (<%= @aggregated_job.nr_files %>)</strong>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Ordine</th>
                <th>Prodotto</th>
                <th>Quantit√†</th>
                <th>File</th>
              </tr>
            </thead>
            <tbody>
              <% @order_items.each_with_index do |item, index| %>
                <tr>
                  <td><strong><%= index + 1 %></strong></td>
                  <td><a href="/orders/<%= item.order.id %>"><%= item.order.external_order_code %></a></td>
                  <td><%= item.sku %></td>
                  <td><%= item.quantity %></td>
                  <td>
                    <% preprint_asset = item.assets.where(asset_type: 'preprint').first || item.assets.order(created_at: :desc).first %>
                    <% if preprint_asset %>
                      <span class="badge bg-success"><i class="fas fa-file"></i> OK</span>
                    <% else %>
                      <span class="badge bg-warning">Nessun file</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <% if @aggregated_job.aggregated_file_url.present? && @aggregated_job.aggregated_at.present? %>
      <div class="card mb-4">
        <div class="card-header <%= @aggregated_job.status == 'preview_pending' ? 'bg-warning' : 'bg-success' %> text-white">
          <strong><i class="fas fa-file-pdf"></i> File Aggregato</strong>
        </div>
        <div class="card-body">
          <p>
            <strong>File:</strong> <%= @aggregated_job.aggregated_filename %><br>
            <strong>Ricevuto:</strong> <%= @aggregated_job.aggregated_at.strftime('%d/%m/%Y %H:%M') %>
          </p>
          <a href="<%= @aggregated_job.aggregated_file_url %>" target="_blank" class="btn btn-primary">
            <i class="fas fa-download"></i> Apri PDF
          </a>
        </div>
      </div>
    <% end %>
  </div>

  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header">
        <strong><i class="fas fa-info-circle"></i> Informazioni</strong>
      </div>
      <div class="card-body">
        <p>
          <strong>ID:</strong> #<%= @aggregated_job.id %><br>
          <strong>File:</strong> <%= @aggregated_job.nr_files %><br>
          <strong>Creato:</strong> <%= @aggregated_job.created_at.strftime('%d/%m/%Y %H:%M') %><br>
          <% if @aggregated_job.sent_at %>
            <strong>Inviato:</strong> <%= @aggregated_job.sent_at.strftime('%d/%m/%Y %H:%M') %><br>
          <% end %>
          <% if @aggregated_job.completed_at %>
            <strong>Completato:</strong> <%= @aggregated_job.completed_at.strftime('%d/%m/%Y %H:%M') %>
          <% end %>
        </p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <strong><i class="fas fa-cogs"></i> Azioni</strong>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/aggregated_jobs/<%= @aggregated_job.id %>/print" class="btn btn-outline-info w-100 mb-2" target="_blank">
            <i class="fas fa-file-invoice"></i> Scheda Lavoro
          </a>
          
          <% if @aggregated_job.status == 'pending' %>
            <div class="mb-2">
              <label class="form-label small"><strong>Operazioni Disponibili:</strong></label>
            </div>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/send_preprint" method="post" class="mb-2">
              <button type="submit" class="btn btn-info w-100" onclick="return confirm('Invia file aggregato a pre-stampa?')">
                <i class="fas fa-scissors"></i> Pre-Stampa
              </button>
            </form>
            <button type="button" class="btn btn-primary w-100 mb-2" 
                    data-bs-toggle="modal" data-bs-target="#machineSelectAggregatedModal"
                    disabled title="Completa prima la pre-stampa">
              <i class="fas fa-print"></i> Stampa
            </button>
            <% if @aggregated_job.print_flow&.label_webhook.present? %>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/send_label" method="post" class="mb-2">
              <button type="submit" class="btn btn-secondary w-100" disabled title="Completa prima la pre-stampa">
                <i class="fas fa-tag"></i> Etichetta
              </button>
            </form>
            <% end %>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/reset" method="post" class="mb-2">
              <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Resettare a In Attesa?')">
                <i class="fas fa-redo"></i> Resetta
              </button>
            </form>
            <hr>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>" method="post">
              <input type="hidden" name="_method" value="delete">
              <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Elimina questa aggregazione?')">
                <i class="fas fa-trash"></i> Elimina
              </button>
            </form>

          <% elsif @aggregated_job.status == 'aggregating' %>
            <div class="alert alert-info mb-0">
              <i class="fas fa-spinner fa-spin"></i> Aggregazione in corso...
              <br><small>In attesa del file aggregato da Switch</small>
            </div>

          <% elsif @aggregated_job.status == 'preview_pending' %>
            <div class="mb-2">
              <label class="form-label small"><strong>Operazioni Disponibili:</strong></label>
            </div>
            <% if !@aggregated_job.preprint_sent_at.present? %>
              <form action="/aggregated_jobs/<%= @aggregated_job.id %>/confirm_preprint" method="post" class="mb-2">
                <button type="submit" class="btn btn-success w-100" onclick="return confirm('File aggregato pronto per la stampa?')">
                  <i class="fas fa-check"></i> Conferma Pre-Stampa
                </button>
              </form>
            <% else %>
              <div class="alert alert-success mb-2">
                <i class="fas fa-check"></i> Pre-stampa confermata, pronto per stampa
              </div>
            <% end %>
            <button type="button" class="btn btn-primary w-100 mb-2" 
                    data-bs-toggle="modal" data-bs-target="#machineSelectAggregatedModal"
                    <% if !@aggregated_job.preprint_sent_at.present? %>disabled title="Conferma prima la pre-stampa"<% end %>>
              <i class="fas fa-print"></i> Stampa
            </button>
            <% if @aggregated_job.print_flow&.label_webhook.present? %>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/send_label" method="post" class="mb-2">
              <button type="submit" class="btn btn-secondary w-100" onclick="return confirm('Invia file aggregato a etichetta?')">
                <i class="fas fa-tag"></i> Etichetta
              </button>
            </form>
            <% end %>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/reset" method="post">
              <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Resettare a In Attesa?')">
                <i class="fas fa-redo"></i> Resetta
              </button>
            </form>

          <% elsif @aggregated_job.status == 'aggregated' %>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/send_print" method="post">
              <div class="mb-2">
                <label class="form-label small">Webhook Stampa:</label>
                <select name="webhook_path" class="form-select form-select-sm" required>
                  <option value="">-- Seleziona --</option>
                  <% @switch_webhooks.each do |wh| %>
                    <option value="<%= wh.hook_path %>"><%= wh.name %></option>
                  <% end %>
                </select>
              </div>
              <button type="submit" class="btn btn-success w-100" onclick="return confirm('Invia file aggregato a stampa?')">
                <i class="fas fa-print"></i> Invia a Stampa
              </button>
            </form>
            <hr>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/mark_completed" method="post">
              <button type="submit" class="btn btn-outline-success w-100" onclick="return confirm('Segnare come completato manualmente?')">
                <i class="fas fa-check"></i> Completa Manualmente
              </button>
            </form>

          <% elsif @aggregated_job.status == 'printing' %>
            <div class="alert alert-primary mb-2">
              <i class="fas fa-print"></i> Stampa in corso...
            </div>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/mark_completed" method="post" class="mb-2">
              <button type="submit" class="btn btn-success w-100" onclick="return confirm('Chiudere il lavoro? Tutti i line items saranno segnati come completati.')">
                <i class="fas fa-check-circle"></i> Conferma Stampa e Chiudi
              </button>
            </form>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/reset" method="post">
              <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Resettare a In Attesa?')">
                <i class="fas fa-redo"></i> Resetta
              </button>
            </form>

          <% elsif @aggregated_job.status == 'completed' %>
            <div class="alert alert-success mb-2">
              <i class="fas fa-check-circle"></i> Lavoro completato!
            </div>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/reset" method="post" class="mb-2">
              <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Resettare a In Attesa?')">
                <i class="fas fa-redo"></i> Resetta
              </button>
            </form>

          <% elsif @aggregated_job.status == 'failed' %>
            <div class="alert alert-danger mb-2">
              <i class="fas fa-exclamation-triangle"></i> Lavoro fallito
            </div>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>/reset" method="post" class="mb-2">
              <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Resettare a In Attesa?')">
                <i class="fas fa-redo"></i> Resetta
              </button>
            </form>
            <form action="/aggregated_jobs/<%= @aggregated_job.id %>" method="post">
              <input type="hidden" name="_method" value="delete">
              <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Elimina questa aggregazione?')">
                <i class="fas fa-trash"></i> Elimina
              </button>
            </form>
          <% end %>
          
          <hr>
          <a href="/aggregated_jobs" class="btn btn-outline-secondary w-100">
            <i class="fas fa-arrow-left"></i> Indietro
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Select Machine for Aggregated Print -->
<div class="modal fade" id="machineSelectAggregatedModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scegli Stampante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/aggregated_jobs/<%= @aggregated_job.id %>/send_print" method="post">
        <div class="modal-body">
          <p class="text-muted mb-3">Seleziona stampante per questo aggregato:</p>
          <% available_machines = @aggregated_job.print_flow&.print_machines || [] %>
          <% if available_machines.any? %>
            <% available_machines.each do |machine| %>
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="print_machine_id" 
                       value="<%= machine.id %>" id="agg_machine_<%= machine.id %>"
                       <%= 'checked' if available_machines.first.id == machine.id %>>
                <label class="form-check-label" for="agg_machine_<%= machine.id %>">
                  <strong><%= machine.name %></strong>
                  <% if machine.description %>
                    <br><small class="text-muted"><%= machine.description %></small>
                  <% end %>
                </label>
              </div>
            <% end %>
          <% else %>
            <div class="alert alert-warning">Nessuna stampante disponibile nel flusso</div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="submit" class="btn btn-primary" <% if available_machines.empty? %>disabled<% end %>><i class="fas fa-print"></i> Invia a Stampa</button>
        </div>
      </form>
    </div>
  </div>
</div>

