<section>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
      <h1>üìã Ordini</h1>
      <p style="margin: 0.5rem 0 0 0; color: var(--muted-color);">
        <strong><%= @orders.count %></strong> ordini totali
        <% if @filter_order_code.present? || @filter_store.present? || @filter_order_date.present? %>
          | <a href="/orders" style="text-decoration: underline;">‚úï Azzera filtri</a>
        <% end %>
      </p>
    </div>
    <a href="/orders/new" role="button">‚ûï Nuovo Ordine</a>
  </div>

  <% if @orders.empty? %>
    <article>
      <h5>‚ÑπÔ∏è Nessun ordine</h5>
      <p>Gli ordini appariranno qui quando importati via API o caricati manualmente.</p>
    </article>
  <% else %>
    <% in_progress = @orders.select { |o| %w[new sent_to_switch processing].include?(o.status) } %>
    <% completed = @orders.select { |o| %w[done error].include?(o.status) } %>
    
    <ul role="tablist" style="display: flex; gap: 1rem; border-bottom: 2px solid var(--muted-border-color); padding: 0; margin: 0; list-style: none;">
      <li role="presentation">
        <button role="tab" aria-controls="in-progress" aria-selected="true" style="background: none; border: none; padding: 1rem; border-bottom: 3px solid var(--primary-color); cursor: pointer; font-weight: 600;">
          ‚è≥ In Lavorazione <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 0.3rem; margin-left: 0.5rem; font-weight: normal; font-size: 0.9rem;"><%= in_progress.count %></span>
        </button>
      </li>
      <li role="presentation">
        <button role="tab" aria-controls="completed" aria-selected="false" style="background: none; border: none; padding: 1rem; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted-color);">
          ‚úÖ Completati <span style="background: var(--muted-color); color: white; padding: 0.25rem 0.5rem; border-radius: 0.3rem; margin-left: 0.5rem; font-weight: normal; font-size: 0.9rem;"><%= completed.count %></span>
        </button>
      </li>
      <li role="presentation">
        <button role="tab" aria-controls="errors" aria-selected="false" style="background: none; border: none; padding: 1rem; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted-color);">
          ‚ö†Ô∏è Errori <span style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 0.3rem; margin-left: 0.5rem; font-weight: normal; font-size: 0.9rem;"><%= @import_errors.count %></span>
        </button>
      </li>
    </ul>

    <!-- In Progress Tab -->
    <article id="in-progress" role="tabpanel" style="margin-top: 1rem;">
      <% if in_progress.empty? %>
        <p style="color: var(--muted-color); font-style: italic;">Nessun ordine in lavorazione</p>
      <% else %>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th style="width: 10%;">Data</th>
                <th style="width: 15%;">Negozio</th>
                <th style="width: 15%;">Codice Ordine</th>
                <th style="width: 12%;">Stato</th>
                <th style="width: 8%;">Item</th>
                <th style="width: 15%;">Asset</th>
                <th style="width: 15%;">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr style="background-color: var(--muted-background-color);">
                <td>
                  <form method="get" action="/orders" style="display: contents;">
                    <input type="date" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()" style="font-size: 0.9rem;">
                </td>
                <td>
                    <select name="store_id" onchange="this.form.submit()" style="font-size: 0.9rem;">
                      <option value="">Tutti i negozi</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td>
                    <input type="text" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()" style="font-size: 0.9rem;">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td style="text-align: right;">
                    <a href="/orders" role="button" class="btn-small" style="margin: 0;">Azzera</a>
                  </form>
                </td>
              </tr>
            </thead>
            <tbody>
              <% in_progress.each do |order| %>
                <tr>
                  <td><strong><%= order.created_at.strftime('%d-%m-%y') %></strong></td>
                  <td><%= order.store.name %></td>
                  <td>
                    <a href="/orders/<%= order.id %>" style="font-weight: 600;">
                      <%= order.external_order_code %>
                    </a>
                  </td>
                  <td>
                    <span class="status-badge status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td><strong><%= order.order_items.count %></strong></td>
                  <td>
                    <%= order.assets.count %> file
                    <% if order.assets_downloaded? %>
                      <span style="background: #198754; color: white; padding: 0.2rem 0.4rem; border-radius: 0.2rem; margin-left: 0.3rem; font-weight: 600; font-size: 0.85rem;">‚úì</span>
                    <% else %>
                      <span style="background: #ffc107; color: #000; padding: 0.2rem 0.4rem; border-radius: 0.2rem; margin-left: 0.3rem; font-weight: 600; font-size: 0.85rem;">pending</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="btn-group" style="gap: 0.3rem;">
                      <a href="/orders/<%= order.id %>" role="button" class="btn-small" title="Visualizza">üëÅÔ∏è Apri</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" style="margin: 0; display: inline;">
                        <button type="submit" role="button" class="btn-small" title="Duplica ordine">üìã Copia</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" style="margin: 0; display: inline;" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" role="button" class="btn-small" style="border-color: #dc3545; color: #dc3545;" title="Cancella ordine">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </article>

    <!-- Completed Tab -->
    <article id="completed" role="tabpanel" style="margin-top: 1rem; display: none;">
      <% if completed.empty? %>
        <p style="color: var(--muted-color); font-style: italic;">Nessun ordine completato</p>
      <% else %>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th style="width: 10%;">Data</th>
                <th style="width: 15%;">Negozio</th>
                <th style="width: 15%;">Codice Ordine</th>
                <th style="width: 12%;">Stato</th>
                <th style="width: 8%;">Item</th>
                <th style="width: 15%;">Asset</th>
                <th style="width: 15%;">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr style="background-color: var(--muted-background-color);">
                <td>
                  <form method="get" action="/orders" style="display: contents;">
                    <input type="date" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()" style="font-size: 0.9rem;">
                </td>
                <td>
                    <select name="store_id" onchange="this.form.submit()" style="font-size: 0.9rem;">
                      <option value="">Tutti i negozi</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td>
                    <input type="text" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()" style="font-size: 0.9rem;">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td style="text-align: right;">
                    <a href="/orders" role="button" class="btn-small" style="margin: 0;">Azzera</a>
                  </form>
                </td>
              </tr>
            </thead>
            <tbody>
              <% completed.each do |order| %>
                <tr>
                  <td><strong><%= order.created_at.strftime('%d-%m-%y') %></strong></td>
                  <td><%= order.store.name %></td>
                  <td>
                    <a href="/orders/<%= order.id %>" style="font-weight: 600;">
                      <%= order.external_order_code %>
                    </a>
                  </td>
                  <td>
                    <span class="status-badge status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td><strong><%= order.order_items.count %></strong></td>
                  <td>
                    <%= order.assets.count %> file
                    <% if order.assets_downloaded? %>
                      <span style="background: #198754; color: white; padding: 0.2rem 0.4rem; border-radius: 0.2rem; margin-left: 0.3rem; font-weight: 600; font-size: 0.85rem;">‚úì</span>
                    <% else %>
                      <span style="background: #ffc107; color: #000; padding: 0.2rem 0.4rem; border-radius: 0.2rem; margin-left: 0.3rem; font-weight: 600; font-size: 0.85rem;">pending</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="btn-group" style="gap: 0.3rem;">
                      <a href="/orders/<%= order.id %>" role="button" class="btn-small" title="Visualizza">üëÅÔ∏è Apri</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" style="margin: 0; display: inline;">
                        <button type="submit" role="button" class="btn-small" title="Duplica ordine">üìã Copia</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" style="margin: 0; display: inline;" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" role="button" class="btn-small" style="border-color: #dc3545; color: #dc3545;" title="Cancella ordine">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </article>

    <!-- Errors Tab -->
    <article id="errors" role="tabpanel" style="margin-top: 1rem; display: none;">
      <% if @import_errors.empty? %>
        <p style="color: var(--muted-color); font-style: italic;">‚úì Nessun errore di importazione</p>
      <% else %>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <strong><%= @import_errors.count %> errori</strong>
          <form action="/import_errors/clear_all" method="post" style="margin: 0;" onsubmit="return confirm('Cancellare TUTTI gli errori? Questa azione non pu√≤ essere annullata.');">
            <button type="submit" role="button" style="border-color: #dc3545; color: #dc3545;">üóëÔ∏è Cancella tutti</button>
          </form>
        </div>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th style="width: 12%;">Data</th>
                <th style="width: 15%;">Codice Ordine</th>
                <th style="width: 20%;">File</th>
                <th style="width: 38%;">Errore</th>
                <th style="width: 15%;">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr style="background-color: var(--muted-background-color);">
                <td>
                  <form method="get" action="/orders" style="display: contents;">
                    <input type="date" name="error_date" value="<%= @filter_error_date %>" onchange="this.form.submit()" style="font-size: 0.9rem;">
                </td>
                <td>
                    <input type="text" name="error_order_code" placeholder="Codice..." value="<%= @filter_error_order_code %>" onchange="this.form.submit()" style="font-size: 0.9rem;">
                </td>
                <td></td>
                <td></td>
                <td style="text-align: right;">
                    <a href="/orders" role="button" class="btn-small" style="margin: 0;">Azzera</a>
                  </form>
                </td>
              </tr>
            </thead>
            <tbody>
              <% @import_errors.each do |error| %>
                <tr>
                  <td><strong><%= error.created_at.strftime('%d-%m-%y %H:%M') %></strong></td>
                  <td>
                    <a href="/orders" style="font-weight: 600;">
                      <%= error.external_order_code %>
                    </a>
                  </td>
                  <td><code style="font-size: 0.85rem; background: var(--muted-background-color); padding: 0.2rem 0.4rem; border-radius: 0.3rem;"><%= error.filename %></code></td>
                  <td style="color: #dc3545; font-size: 0.9rem;">
                    <%= error.error_message %>
                  </td>
                  <td>
                    <form action="/import_errors/<%= error.id %>/delete" method="post" style="margin: 0;" onsubmit="return confirm('Cancellare questo errore?');">
                      <button type="submit" role="button" class="btn-small" style="border-color: #dc3545; color: #dc3545;">üóë</button>
                    </form>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </article>

    <script>
      // Simple tab switching
      document.querySelectorAll('ul[role="tablist"] button').forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.getAttribute('aria-controls');
          
          // Hide all tabs and deselect buttons
          document.querySelectorAll('article[role="tabpanel"]').forEach(tab => tab.style.display = 'none');
          document.querySelectorAll('ul[role="tablist"] button').forEach(btn => {
            btn.setAttribute('aria-selected', 'false');
            btn.style.borderBottomColor = 'transparent';
            btn.style.color = 'var(--muted-color)';
          });
          
          // Show selected tab and select button
          document.getElementById(tabId).style.display = 'block';
          this.setAttribute('aria-selected', 'true');
          this.style.borderBottomColor = 'var(--primary-color)';
          this.style.color = 'inherit';
        });
      });
    </script>
  <% end %>
</section>
