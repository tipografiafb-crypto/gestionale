<div class="mb-6 flex justify-between items-center">
  <div>
    <h1 class="text-3xl font-bold text-gray-900">üìã Ordini</h1>
    <p class="text-gray-600 mt-2">Gestione e tracciamento degli ordini di stampa</p>
  </div>
  <a href="/orders/new" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition inline-flex items-center gap-2">
    ‚ûï Nuovo Ordine
  </a>
</div>

<% if @orders.empty? %>
  <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded">
    <h3 class="text-lg font-semibold text-blue-900">Non ci sono ordini</h3>
    <p class="text-blue-700 mt-2">Gli ordini appariranno qui quando importati tramite:</p>
    <code class="bg-blue-100 px-3 py-1 rounded inline-block mt-2 text-sm">POST /api/orders/import</code>
  </div>
<% else %>
  <% in_progress = @orders.select { |o| %w[new sent_to_switch processing].include?(o.status) } %>
  <% completed = @orders.select { |o| %w[done error].include?(o.status) } %>
  
  <!-- Tabs -->
  <div class="mb-6">
    <div class="flex gap-4 border-b border-gray-200">
      <button class="tab-button active px-4 py-3 border-b-2 border-blue-600 text-blue-600 font-semibold transition" data-tab="in-progress">
        ‚è≥ In Lavorazione <span class="ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm"><%= in_progress.count %></span>
      </button>
      <button class="tab-button px-4 py-3 border-b-2 border-transparent text-gray-600 font-semibold hover:text-gray-900 transition" data-tab="completed">
        ‚úÖ Completati <span class="ml-2 bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm"><%= completed.count %></span>
      </button>
      <button class="tab-button px-4 py-3 border-b-2 border-transparent text-gray-600 font-semibold hover:text-gray-900 transition" data-tab="errors">
        ‚ö†Ô∏è Errori <span class="ml-2 bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm"><%= @import_errors.count %></span>
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div id="tab-content">
    <!-- In Progress Tab -->
    <div id="in-progress-tab" class="tab-pane">
      <% if in_progress.empty? %>
        <p class="text-gray-500 py-8 text-center">Nessun ordine in lavorazione</p>
      <% else %>
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Negozio</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Codice Ordine</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Stato</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Item</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Asset</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Azioni</th>
              </tr>
              <!-- Filter Row -->
              <tr class="bg-gray-50 border-b border-gray-200">
                <td class="px-6 py-3">
                  <form method="get" action="/orders" class="inline">
                    <input type="date" class="text-sm border border-gray-300 rounded px-2 py-1" name="order_date" value="<%= @filter_order_date %>" onchange="this.form.submit()">
                </td>
                <td class="px-6 py-3">
                    <select class="text-sm border border-gray-300 rounded px-2 py-1" name="store_id" onchange="this.form.submit()">
                      <option value="">Tutti</option>
                      <% @stores.each do |store| %>
                        <option value="<%= store.id %>" <%= 'selected' if @filter_store == store.id.to_s %>>
                          <%= store.name %>
                        </option>
                      <% end %>
                    </select>
                </td>
                <td class="px-6 py-3">
                    <input type="text" class="text-sm border border-gray-300 rounded px-2 py-1" name="order_code" placeholder="Codice..." value="<%= @filter_order_code %>" onchange="this.form.submit()">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td class="px-6 py-3">
                  <a href="/orders" class="text-blue-600 hover:text-blue-800 text-sm font-medium">‚úï Reset</a>
                  </form>
                </td>
              </tr>
            </thead>
            <tbody>
              <% in_progress.each do |order| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                  <td class="px-6 py-4 text-sm text-gray-700"><%= order.created_at.strftime('%d-%m-%y') %></td>
                  <td class="px-6 py-4 text-sm text-gray-700"><%= order.store.name %></td>
                  <td class="px-6 py-4 text-sm"><a href="/orders/<%= order.id %>" class="text-blue-600 hover:text-blue-800 font-medium"><%= order.external_order_code %></a></td>
                  <td class="px-6 py-4">
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-700"><%= order.order_items.count %></td>
                  <td class="px-6 py-4 text-sm">
                    <div class="flex items-center gap-2">
                      <span><%= order.assets.count %> total</span>
                      <% if order.assets_downloaded? %>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">‚úì</span>
                      <% else %>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-semibold">pending</span>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex gap-2">
                      <a href="/orders/<%= order.id %>" class="text-gray-600 hover:text-gray-900 text-lg" title="Visualizza">üëÅÔ∏è</a>
                      <form action="/orders/<%= order.id %>/duplicate" method="post" class="inline">
                        <button type="submit" class="text-gray-600 hover:text-gray-900 text-lg" title="Duplica">üìã</button>
                      </form>
                      <form action="/orders/<%= order.id %>" method="post" class="inline" onsubmit="return confirm('Cancellare questo ordine?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="text-gray-600 hover:text-red-600 text-lg" title="Cancella">üóë</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Completed Tab -->
    <div id="completed-tab" class="tab-pane hidden">
      <% if completed.empty? %>
        <p class="text-gray-500 py-8 text-center">Nessun ordine completato</p>
      <% else %>
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Negozio</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Codice Ordine</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Stato</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Item</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Asset</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <% completed.each do |order| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                  <td class="px-6 py-4 text-sm text-gray-700"><%= order.created_at.strftime('%d-%m-%y') %></td>
                  <td class="px-6 py-4 text-sm text-gray-700"><%= order.store.name %></td>
                  <td class="px-6 py-4 text-sm"><a href="/orders/<%= order.id %>" class="text-blue-600 hover:text-blue-800 font-medium"><%= order.external_order_code %></a></td>
                  <td class="px-6 py-4">
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold status-<%= order.status %>">
                      <%= order.status.gsub('_', ' ').upcase %>
                    </span>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-700"><%= order.order_items.count %></td>
                  <td class="px-6 py-4 text-sm">
                    <span><%= order.assets.count %> total</span> 
                    <% if order.assets_downloaded? %>
                      <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‚úì</span>
                    <% end %>
                  </td>
                  <td class="px-6 py-4">
                    <a href="/orders/<%= order.id %>" class="text-gray-600 hover:text-gray-900 text-lg" title="Visualizza">üëÅÔ∏è</a>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Errors Tab -->
    <div id="errors-tab" class="tab-pane hidden">
      <% if @import_errors.empty? %>
        <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded">
          <p class="text-green-800 font-semibold">‚úì Nessun errore di importazione</p>
        </div>
      <% else %>
        <div class="mb-4 flex justify-end">
          <form action="/import_errors/clear_all" method="post" onsubmit="return confirm('Cancellare TUTTI gli errori? Questa azione non pu√≤ essere annullata.');">
            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition">
              üóëÔ∏è Cancella tutti gli errori
            </button>
          </form>
        </div>
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Codice Ordine</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">File</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Errore</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <% @import_errors.each do |error| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                  <td class="px-6 py-4 text-sm text-gray-700"><%= error.created_at.strftime('%d-%m-%y %H:%M') %></td>
                  <td class="px-6 py-4 text-sm font-semibold text-gray-900"><%= error.external_order_code %></td>
                  <td class="px-6 py-4 text-sm"><code class="bg-gray-100 px-2 py-1 rounded text-xs"><%= error.filename %></code></td>
                  <td class="px-6 py-4 text-sm text-red-600"><%= error.error_message %></td>
                  <td class="px-6 py-4">
                    <form action="/import_errors/<%= error.id %>/delete" method="post" class="inline" onsubmit="return confirm('Cancellare questo errore?');">
                      <button type="submit" class="text-red-600 hover:text-red-800 text-lg" title="Cancella">üóë</button>
                    </form>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>

  <script>
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        document.querySelectorAll('.tab-button').forEach(b => {
          b.classList.remove('border-blue-600', 'text-blue-600');
          b.classList.add('border-transparent', 'text-gray-600');
        });
        button.classList.add('border-blue-600', 'text-blue-600');
        button.classList.remove('border-transparent', 'text-gray-600');
        
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
        document.getElementById(tab + '-tab').classList.remove('hidden');
      });
    });
  </script>
<% end %>
