<div class="mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/orders">Orders</a></li>
      <li class="breadcrumb-item active">Admin</li>
      <li class="breadcrumb-item active">Backup</li>
    </ol>
  </nav>
</div>

<div class="row mb-4">
  <div class="col-md-8">
    <h1><i class="fas fa-database"></i> Backup Database e File</h1>
  </div>
</div>

<% if params[:msg] %>
  <% alert_type = case params[:msg]
    when 'success'
      'success'
    when 'info'
      'info'
    else
      'danger'
    end %>
  <div class="alert alert-<%= alert_type %> alert-dismissible fade show" role="alert">
    <%= params[:text]&.gsub('+', ' ') %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% end %>

<div class="row">
  <!-- Configurazione Backup -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <strong><i class="fas fa-cog"></i> Configurazione Backup Remoto</strong>
      </div>
      <div class="card-body">
        <form action="/admin/backup/config" method="post">
          <div class="mb-3">
            <label for="remote_ip" class="form-label">IP Macchina Switch</label>
            <input type="text" class="form-control" id="remote_ip" name="remote_ip" 
                   value="<%= @backup_config.remote_ip %>" placeholder="es: 192.168.1.100" required>
            <small class="text-muted">Indirizzo IP della macchina Switch per backup remoto</small>
          </div>

          <div class="mb-3">
            <label for="remote_path" class="form-label">Percorso Remoto</label>
            <input type="text" class="form-control" id="remote_path" name="remote_path" 
                   value="<%= @backup_config.remote_path %>" placeholder="es: /mnt/backup" required>
            <small class="text-muted">Percorso assoluto sul server Switch dove salvare i backup</small>
          </div>

          <div class="mb-3">
            <label for="ssh_username" class="form-label">Username SSH</label>
            <input type="text" class="form-control" id="ssh_username" name="ssh_username" 
                   value="<%= @backup_config.ssh_username %>" placeholder="es: root" required>
            <small class="text-muted">Utente SSH per la connessione al Mac remoto</small>
          </div>

          <div class="mb-3">
            <label for="ssh_password" class="form-label">Password SSH</label>
            <input type="password" class="form-control" id="ssh_password" name="ssh_password" 
                   value="<%= @backup_config.ssh_password %>" placeholder="••••••••" required>
            <small class="text-muted">Password per l'autenticazione SSH (non richiede chiavi pubbliche)</small>
          </div>

          <div class="mb-3">
            <label for="ssh_port" class="form-label">Porta SSH (opzionale)</label>
            <input type="number" class="form-control" id="ssh_port" name="ssh_port" 
                   value="<%= @backup_config.ssh_port || 22 %>" placeholder="22" min="1" max="65535">
            <small class="text-muted">Porta SSH - predefinita 22 se lasciata vuota</small>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-save"></i> Salva Configurazione
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Esecuzione Backup -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <strong><i class="fas fa-cloud-upload-alt"></i> Esecuzione Backup</strong>
      </div>
      <div class="card-body">
        <p class="text-muted">Esegui il backup manualmente o verifica la connessione alla macchina Switch.</p>
        <div class="d-grid gap-2">
          <form action="/admin/backup/test" method="post">
            <input type="hidden" name="remote_ip" value="<%= @backup_config.remote_ip %>">
            <input type="hidden" name="remote_path" value="<%= @backup_config.remote_path %>">
            <button type="submit" class="btn btn-outline-info w-100">
              <i class="fas fa-wifi"></i> Test Connessione SSH
            </button>
          </form>

          <form action="/admin/backup/now" method="post">
            <button type="submit" class="btn btn-success w-100" 
                    onclick="return confirm('Esegui backup ORA? Database + file verranno compressi e salvati su Switch.')">
              <i class="fas fa-play"></i> Esegui Backup ORA
            </button>
          </form>
        </div>
        
        <hr>
        
        <h6 class="mt-3"><i class="fas fa-clock"></i> Backup Automatico</h6>
        <p class="text-muted small mb-0">Il backup verrà eseguito automaticamente ogni notte alle 02:00 (dopo cron setup).</p>
        <p class="text-muted small">
          <small><strong>Cosa viene salvato:</strong></small><br>
          <small>✓ Database PostgreSQL completo</small><br>
          <small>✓ Cartella storage/ (tutti i file importati e processati)</small><br>
          <small>✓ File .zip con timestamp</small>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Disaster Recovery - Upload backup -->
<div class="card mb-4">
  <div class="card-header">
    <strong><i class="fas fa-upload"></i> Disaster Recovery (Carica Backup da Esterno)</strong>
  </div>
  <div class="card-body">
    <p class="text-muted mb-3">Carica un backup salvato su Switch per ripristinarlo in caso di crash. ATTENZIONE: Sovrascriverà completamente il database e tutti i file nella cartella storage/!</p>
    <form action="/admin/backup/restore_upload" method="post" enctype="multipart/form-data" id="restoreForm">
      <div class="mb-3">
        <label for="backup_file" class="form-label">Seleziona file backup (.zip)</label>
        <input type="file" class="form-control" id="backup_file" name="backup_file" 
               accept=".zip" required>
        <div class="progress mt-2 d-none" id="uploadProgressContainer">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="uploadProgressBar" style="width: 0%">0%</div>
        </div>
        <small class="text-muted">Solo file .zip (backup_YYYYMMDD_HHMMSS.zip)</small>
      </div>
      <button type="submit" class="btn btn-danger w-100" id="restoreSubmitBtn"
              onclick="return handleRestore(event)">
        <i class="fas fa-exclamation-triangle"></i> Ripristina Backup da Esterno
      </button>
    </form>
  </div>
</div>

<script>
function handleRestore(e) {
  const confirmed = confirm('⚠️ ATTENZIONE CRITICO!\n\nQuesto sovrascriverà:\n✗ Database PostgreSQL COMPLETO\n✗ Tutti i file nella cartella storage/\n✗ L\'intero sistema tornerà allo stato del backup\n\nSei VERAMENTE SICURO? Questa operazione non è reversibile!!');
  
  if (!confirmed) {
    e.preventDefault();
    return false;
  }

  const form = document.getElementById('restoreForm');
  const fileInput = document.getElementById('backup_file');
  const btn = document.getElementById('restoreSubmitBtn');
  const progressContainer = document.getElementById('uploadProgressContainer');
  const progressBar = document.getElementById('uploadProgressBar');

  if (fileInput.files.length === 0) return;

  e.preventDefault();
  
  const formData = new FormData(form);
  const xhr = new XMLHttpRequest();

  xhr.open('POST', '/admin/backup/restore_upload', true);

  xhr.upload.onprogress = function(e) {
    if (e.lengthComputable) {
      const percentComplete = Math.round((e.loaded / e.total) * 100);
      progressContainer.classList.remove('d-none');
      progressBar.style.width = percentComplete + '%';
      progressBar.textContent = percentComplete + '%';
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Caricamento in corso...';
    }
  };

  xhr.onload = function() {
    if (xhr.status === 200) {
      // Reindirizza all'URL restituito o ricarica con successo
      window.location.href = xhr.responseURL || '/admin/backup?msg=success&text=Ripristino+completato';
    } else {
      alert('Errore durante l\'upload o il ripristino. Verifica i log del server.');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ripristina Backup da Esterno';
    }
  };

  xhr.onerror = function() {
    alert('Errore di rete durante l\'upload.');
    btn.disabled = false;
  };

  xhr.send(formData);
  return false;
}
</script>

<!-- Documentazione Cron -->
<div class="card">
  <div class="card-header">
    <strong><i class="fas fa-book"></i> Setup Backup Automatico Notturno</strong>
  </div>
  <div class="card-body">
    <p class="text-muted">Per eseguire il backup automaticamente ogni notte, aggiungi questo comando al cron:</p>
    
    <pre class="bg-light p-3 rounded"><code>crontab -e

# Aggiungi questa riga (backup ogni notte alle 02:00)
0 2 * * * cd /home/runner/workspace && curl -X POST http://localhost:5000/admin/backup/now 2>&1 | tee -a backup.log</code></pre>

    <p class="mt-3 small text-muted">
      <i class="fas fa-info-circle"></i> 
      <strong>Nota:</strong> Sostituisci <code>/home/runner/workspace</code> con il percorso effettivo del tuo progetto 
      e <code>http://localhost:5000</code> con l'URL del tuo server se diverso.
    </p>
  </div>
</div>
