<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <h1><%= @product ? '‚úé Modifica Prodotto' : '‚ûï Nuovo Prodotto' %></h1>
    </div>
    <div class="col-md-4 text-end">
      <a href="/products" class="btn btn-secondary">‚Üê Indietro</a>
    </div>
  </div>

  <% if @error %>
    <div class="alert alert-danger mt-3">
      <strong>‚ö† Errore:</strong> <%= @error %>
    </div>
  <% end %>

  <form method="POST" action="<%= @product ? "/products/#{@product.id}" : '/products' %>" class="mt-4">
    <% if @product %>
      <input type="hidden" name="_method" value="PUT">
    <% end %>
    <input type="hidden" name="authenticity_token" value="<%= session[:csrf] %>">
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="sku" class="form-label">SKU Prodotto <span class="text-danger">*</span></label>
              <input type="text" id="sku" name="sku" class="form-control text-uppercase" 
                     value="<%= @product&.sku %>" placeholder="es. POSTER-A4" required>
              <small class="text-muted">Codice SKU (sar√† convertito in maiuscole)</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="name" class="form-label">Nome Prodotto <span class="text-danger">*</span></label>
              <input type="text" id="name" name="name" class="form-control" 
                     value="<%= @product&.name %>" placeholder="es. Poster A4 Lucido" required>
              <small class="text-muted">Nome descrittivo del prodotto</small>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="product_category_id" class="form-label">Categoria (Opzionale)</label>
              <select id="product_category_id" name="product_category_id" class="form-select">
                <option value="">-- Nessuna categoria --</option>
                <% @categories.each do |category| %>
                  <option value="<%= category.id %>" <%= 'selected' if @product&.product_category_id == category.id %>>
                    <%= category.name %>
                  </option>
                <% end %>
              </select>
              <small class="text-muted">Organizza i prodotti per categorie</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="min_stock_level" class="form-label">Sottoscorta (Opzionale)</label>
              <input type="number" id="min_stock_level" name="min_stock_level" class="form-control" 
                     value="<%= @product&.min_stock_level || 0 %>" min="0" placeholder="es. 50">
              <small class="text-muted">Quantit√† minima prima di avviso (0 = nessuno)</small>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Flussi di Stampa <span class="text-danger">*</span></label>
          <div class="card bg-light p-3">
            <% if @flows.empty? %>
              <p class="text-muted mb-0">Nessun flusso disponibile. <a href="/print_flows/new">Crea un flusso</a></p>
            <% else %>
              <% @flows.each do |flow| %>
                <div class="form-check mb-2">
                  <input type="checkbox" class="form-check-input flow-checkbox" 
                         id="flow_<%= flow.id %>" name="print_flow_ids[]" value="<%= flow.id %>"
                         <%= 'checked' if @product&.print_flows&.include?(flow) %>>
                  <label class="form-check-label" for="flow_<%= flow.id %>">
                    <strong><%= flow.name %></strong> (Pre: <%= flow.preprint_webhook&.name %> ‚Üí Stampa: <%= flow.print_webhook&.name %>)
                  </label>
                </div>
              <% end %>
            <% end %>
          </div>
          <small class="text-muted">Seleziona uno o pi√π flussi per questo prodotto</small>
        </div>

        <div class="mb-3">
          <label for="default_print_flow_id" class="form-label">Flusso di Stampa Default <span class="text-danger">*</span></label>
          <select id="default_print_flow_id" name="default_print_flow_id" class="form-select" required>
            <option value="">-- Seleziona flusso default --</option>
            <% @flows.each do |flow| %>
              <option value="<%= flow.id %>" <%= 'selected' if @product&.default_print_flow_id == flow.id %>>
                <%= flow.name %>
              </option>
            <% end %>
          </select>
          <small class="text-muted">Flusso selezionato di default quando l'operatore sceglie di mandare in pre-stampa</small>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">Note (Opzionale)</label>
          <textarea id="notes" name="notes" class="form-control" rows="3" placeholder="es. Cliente personalizzato, QA speciale..."><%= @product&.notes %></textarea>
          <small class="text-muted">Note interne per il tuo team</small>
        </div>
      </div>

      <div class="card-footer bg-light">
        <button type="submit" class="btn btn-primary">
          <%= @product ? 'üíæ Salva Modifiche' : '‚ûï Crea Prodotto' %>
        </button>
        <a href="/products" class="btn btn-outline-secondary">Annulla</a>
      </div>
    </div>
  </form>
</div>
