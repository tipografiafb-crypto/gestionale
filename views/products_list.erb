<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-md-8">
      <h1>ðŸ“¦ Prodotti (SKU)</h1>
      <p class="text-muted">Configura il routing dei prodotti verso i flussi di stampa</p>
    </div>
    <div class="col-md-4 text-end">
      <a href="/products/new" class="btn btn-primary">âž• Nuovo Prodotto</a>
    </div>
  </div>

  <% if params[:success] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      âœ“ Prodotto <%= params[:success] %> con successo!
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if @products.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>SKU</th>
            <th>Nome Prodotto</th>
            <th>Categoria</th>
            <th>Flusso</th>
            <th>Note</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          <% @products.each do |product| %>
            <tr>
              <td>
                <strong><code><%= product.sku %></code></strong>
              </td>
              <td>
                <%= product.name %>
              </td>
              <td>
                <% if product.product_category %>
                  <span class="badge bg-secondary"><%= product.product_category.name %></span>
                <% else %>
                  <span class="text-muted">â€”</span>
                <% end %>
              </td>
              <td>
                <% if product.print_flows.any? %>
                  <% product.print_flows.each do |flow| %>
                    <% is_default = product.default_print_flow&.id == flow.id %>
                    <span class="badge <%= is_default ? 'bg-primary' : 'bg-info' %>">
                      <%= flow.name %><%= is_default ? ' â˜…' : '' %>
                    </span>
                  <% end %>
                <% else %>
                  <span class="badge bg-warning">Non assegnato</span>
                <% end %>
              </td>
              <td>
                <small><%= product.notes.present? ? product.notes : 'â€”' %></small>
              </td>
              <td>
                <% if product.active %>
                  <span class="badge bg-success">âœ“ Attivo</span>
                <% else %>
                  <span class="badge bg-danger">âœ— Inattivo</span>
                <% end %>
              </td>
              <td>
                <a href="/products/<%= product.id %>/edit" class="btn btn-sm btn-outline-primary">âœŽ Modifica</a>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(<%= product.id %>)">ðŸ—‘ Elimina</button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info">
      ðŸ“­ Nessun prodotto registrato. <a href="/products/new">Crea il primo prodotto</a>
    </div>
  <% end %>
</div>

<script>
function deleteProduct(id) {
  if (confirm('Sei sicuro? Eliminerai questo prodotto dal routing.')) {
    fetch('/products/' + id, { method: 'DELETE' })
      .then(() => location.href = '/products?success=deleted');
  }
}
</script>
